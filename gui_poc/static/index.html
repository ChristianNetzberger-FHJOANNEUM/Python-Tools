<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∏ Photo Tool PoC</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        #app {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab.active {
            color: #4ade80;
            border-bottom-color: #4ade80;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ade80;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #888;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse-scan {
            0% { left: -50%; }
            100% { left: 100%; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .photo-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .photo-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        
        .photo-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            background: #222;
        }
        
        .photo-info {
            margin-top: 10px;
        }
        
        .photo-name {
            font-size: 0.8rem;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        
        .stars {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .star {
            cursor: pointer;
            font-size: 24px;
            color: #333;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .star:hover,
        .star.hover {
            color: #fbbf24;
            transform: scale(1.2);
        }
        
        .star.active {
            color: #fbbf24;
        }
        
        .burst-card {
            background: rgba(74, 222, 128, 0.1);
            border: 2px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .burst-card:hover {
            transform: translateY(-5px);
            background: rgba(74, 222, 128, 0.15);
            box-shadow: 0 8px 24px rgba(74, 222, 128, 0.2);
        }
        
        .burst-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .burst-name {
            font-size: 1rem;
            font-weight: 600;
            color: #4ade80;
        }
        
        .burst-count {
            background: rgba(74, 222, 128, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .burst-thumbnails {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .burst-thumb {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            position: relative;
        }
        
        .burst-thumb-wrapper {
            position: relative;
        }
        
        .best-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(74, 222, 128, 0.9);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .blur-badge {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        
        .blur-badge.good {
            background: rgba(74, 222, 128, 0.8);
            color: #000;
        }
        
        .blur-badge.warning {
            background: rgba(251, 191, 36, 0.8);
        }
        
        .blur-badge.bad {
            background: rgba(239, 68, 68, 0.8);
        }
        
        /* Project Cards */
        .project-card {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(59, 130, 246, 0.15);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
        }
        
        .project-header {
            margin-bottom: 15px;
        }
        
        .project-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .project-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #888;
        }
        
        .project-info {
            padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 15px;
        }
        
        .project-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .project-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            background: rgba(255,255,255,0.1);
            color: #fff;
            min-width: 80px;
        }
        
        .project-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .project-btn.primary {
            background: linear-gradient(135deg, #4ade80, #3b82f6);
        }
        
        .project-btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .project-btn.danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        @media (max-width: 768px) {
            .project-actions {
                flex-direction: column;
            }
            
            .project-btn {
                width: 100%;
            }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            max-width: 1200px;
            width: 100%;
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .browser-folder-item {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .browser-folder-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .browser-folder-item.not-accessible {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4ade80;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .burst-viewer {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }
        
        .main-photo {
            text-align: center;
        }
        
        .main-photo img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .photo-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .nav-btn {
            background: rgba(74, 222, 128, 0.2);
            border: 2px solid rgba(74, 222, 128, 0.5);
            color: #4ade80;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: rgba(74, 222, 128, 0.3);
            transform: scale(1.05);
        }
        
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .sidebar-photo {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .sidebar-photo.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        
        .sidebar-photo:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-photo img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .sidebar-photo-name {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ef4444;
        }
        
        .load-more {
            text-align: center;
            margin: 40px 0;
        }
        
        .load-more button {
            background: linear-gradient(135deg, #4ade80 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .load-more button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
        }
        
        .load-more button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        
        .filter-bar {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .filter-section {
            margin-bottom: 15px;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .filter-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .filter-chip {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            user-select: none;
        }
        
        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .filter-chip.active {
            background: rgba(74, 222, 128, 0.2);
            border-color: rgba(74, 222, 128, 0.5);
            color: #4ade80;
        }
        
        .filter-chip input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-select {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .sort-select:hover,
        .sort-select:focus {
            border-color: rgba(74, 222, 128, 0.5);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .sort-order-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .sort-order-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(74, 222, 128, 0.5);
        }
        
        .filter-stats {
            background: rgba(74, 222, 128, 0.1);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #4ade80;
        }
        
        .color-labels {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            align-items: center;
        }
        
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .color-dot:hover {
            transform: scale(1.3);
            box-shadow: 0 0 8px currentColor;
        }
        
        .color-dot.active {
            border-color: #fff;
            transform: scale(1.2);
        }
        
        .color-dot.red {
            background: #ef4444;
        }
        
        .color-dot.yellow {
            background: #fbbf24;
        }
        
        .color-dot.green {
            background: #4ade80;
        }
        
        .color-dot.blue {
            background: #3b82f6;
        }
        
        .color-dot.purple {
            background: #a855f7;
        }
        
        .color-label-badge {
            position: absolute;
            top: 18px;
            left: 18px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .keywords-container {
            margin-top: 8px;
            min-height: 24px;
        }
        
        .keyword-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .keyword-tag:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }
        
        .keyword-tag .remove {
            margin-left: 4px;
            opacity: 0.7;
            font-weight: bold;
        }
        
        .keyword-tag .remove:hover {
            opacity: 1;
        }
        
        .add-keyword-btn {
            display: inline-block;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            color: #888;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-keyword-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: #fff;
        }
        
        .keyword-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 2px;
        }
        
        .keyword-input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(59, 130, 246, 0.5);
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            outline: none;
            width: 100px;
        }
        
        .keyword-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 150px;
        }
        
        .keyword-suggestion {
            padding: 6px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.85rem;
        }
        
        .keyword-suggestion:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .keyword-suggestion .count {
            color: #888;
            margin-left: 8px;
            font-size: 0.75rem;
        }
        
        .keyword-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .keyword-filter-chip {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid transparent;
            color: #3b82f6;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .keyword-filter-chip:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .keyword-filter-chip.active {
            background: rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.7);
        }
        
        .keyword-filter-chip .count {
            opacity: 0.7;
            margin-left: 4px;
        }
        
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.98);
            display: flex;
            flex-direction: column;
            z-index: 2000;
        }
        
        .lightbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.8);
        }
        
        .lightbox-title {
            font-size: 1.2rem;
            color: #fff;
        }
        
        .lightbox-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .lightbox-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .lightbox-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .lightbox-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        
        .lightbox-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.8);
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #fff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .lightbox-nav:hover {
            background: rgba(74, 222, 128, 0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .lightbox-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .lightbox-nav.prev {
            left: 30px;
        }
        
        .lightbox-nav.next {
            right: 30px;
        }
        
        .lightbox-sidebar {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .lightbox-metadata {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .lightbox-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .lightbox-star {
            cursor: pointer;
            font-size: 32px;
            color: #333;
            transition: all 0.2s ease;
        }
        
        .lightbox-star:hover,
        .lightbox-star.hover {
            color: #fbbf24;
            transform: scale(1.2);
        }
        
        .lightbox-star.active {
            color: #fbbf24;
        }
        
        .lightbox-colors {
            display: flex;
            gap: 8px;
        }
        
        .lightbox-color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid transparent;
        }
        
        .lightbox-color-dot:hover {
            transform: scale(1.2);
            box-shadow: 0 0 12px currentColor;
        }
        
        .lightbox-color-dot.active {
            border-color: #fff;
        }
        
        .keyboard-shortcuts {
            position: absolute;
            bottom: 90px;
            left: 30px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
            opacity: 0.7;
        }
        
        .keyboard-shortcuts kbd {
            background: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 3px;
        }
        
        @media (max-width: 768px) {
            .burst-viewer {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .sidebar-photo {
                min-width: 150px;
            }
            
            .lightbox-nav {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .lightbox-nav.prev {
                left: 10px;
            }
            
            .lightbox-nav.next {
                right: 10px;
            }
            
            .keyboard-shortcuts {
                display: none;
            }
        }
        
        /* ========================================
           SLIDESHOW STYLES
           ======================================== */
        
        .slideshow {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            z-index: 3000;
        }
        
        .slideshow.hide-controls {
            cursor: none;
        }
        
        .slideshow-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%);
            backdrop-filter: blur(10px);
            z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .slideshow.hide-controls .slideshow-header {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
        }
        
        .slideshow-title {
            font-size: 1.2rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slideshow-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .slideshow-image-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        
        .slideshow-image-container.active {
            opacity: 1;
        }
        
        .slideshow-image {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .slideshow-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 30px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%);
            backdrop-filter: blur(10px);
            z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .slideshow.hide-controls .slideshow-footer {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none;
        }
        
        .slideshow-progress {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .slideshow-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        
        .slideshow-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .slideshow-progress-text {
            color: #888;
            font-size: 0.9rem;
            min-width: 80px;
            text-align: right;
        }
        
        .slideshow-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .slideshow-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .slideshow-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .slideshow-btn.primary {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
        }
        
        .slideshow-btn.primary:hover {
            background: linear-gradient(135deg, #7c3aed, #db2777);
            transform: scale(1.05);
        }
        
        .slideshow-settings {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .slideshow-setting {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .slideshow-setting select,
        .slideshow-setting input[type="range"] {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .slideshow-setting input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .slideshow-controls {
                flex-wrap: wrap;
            }
            
            .slideshow-settings {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="margin: 0;">
                    <span>üì∏</span>
                    <span>Photo Tool PoC</span>
                </h1>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.9rem; color: #888;">Workspace:</span>
                    <select v-model="currentWorkspace" @change="switchWorkspace"
                            style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; min-width: 200px;">
                        <option v-for="ws in workspaces" :key="ws.path" :value="ws.path" style="background: #1a1a1a;">
                            {{ ws.name }}
                        </option>
                    </select>
                    
                    <span style="font-size: 0.9rem; color: #888; margin-left: 20px;">Project:</span>
                    <select v-model="currentProjectId" @change="onProjectChange"
                            style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; min-width: 200px;">
                        <option :value="null" style="background: #1a1a1a;">
                            No project selected
                        </option>
                        <option v-for="proj in projects" :key="proj.id" :value="proj.id" style="background: #1a1a1a;">
                            {{ proj.name }}
                        </option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="tabs">
                    <button class="tab" :class="{ active: currentView === 'media' }" @click="switchToMedia">
                        üì± Media Manager
                    </button>
                    <button class="tab" :class="{ active: currentView === 'photos' }" @click="switchToPhotosView">
                        üì∏ Photos
                    </button>
                    <button class="tab" :class="{ active: currentView === 'bursts' }" @click="switchToBursts">
                        üì¶ Bursts {{ bursts.length > 0 ? `(${bursts.length})` : '' }}
                    </button>
                    <button class="tab" :class="{ active: currentView === 'projects' }" @click="switchToProjects">
                        üìÅ Projects {{ projects.length > 0 ? `(${projects.length})` : '' }}
                    </button>
                    <button class="tab" :class="{ active: currentView === 'workspaces' }" @click="switchToWorkspaces">
                        üóÇÔ∏è Workspaces
                    </button>
                </div>
                
                <div v-if="currentView === 'photos' && filteredPhotos.length > 0" style="display: flex; gap: 10px;">
                    <button @click="startSlideshow"
                            style="background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s;">
                        üé¨ Slideshow ({{ filteredPhotos.length }})
                    </button>
                    
                    <button @click="openExportModal"
                            style="background: linear-gradient(135deg, #4ade80, #3b82f6); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s;">
                        üì¶ Export Gallery ({{ filteredPhotos.length }})
                    </button>
                </div>
            </div>
            
            <div v-if="stats" class="stats">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_photos }}</div>
                    <div>Total Photos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.rated_photos }}</div>
                    <div>Rated</div>
                </div>
                <div v-if="burstStats.total > 0" class="stat-card" style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.3);">
                    <div class="stat-value" style="color: #fbbf24;">{{ burstStats.total }}</div>
                    <div>Burst Photos</div>
                </div>
                <div v-if="blurDetectionStats" class="stat-card" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3);">
                    <div class="stat-value" style="color: #ef4444;">{{ blurDetectionStats.flagged_count }}</div>
                    <div>Blurry Photos</div>
                </div>
            </div>
        </header>
        
        <!-- Media Manager View -->
        <div v-if="currentView === 'media'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="font-size: 1.5rem; margin: 0 0 10px 0;">üì± Media Manager</h2>
                    <p style="color: #888; font-size: 0.9rem; margin: 0;">
                        Register and scan all your media folders. Pre-scanned folders load instantly in workspaces.
                    </p>
                </div>
                <button @click="showAddMediaFolderModal = true"
                        style="background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    ‚ûï Add Media Folder
                </button>
                <button @click="showConfigInfo"
                        style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    üìã Show Config
                </button>
            </div>
            
            <!-- Media Folders List -->
            <div v-if="mediaFolders.length === 0 && !loadingMedia" class="loading">
                <div style="font-size: 3rem; margin-bottom: 20px;">üì±</div>
                <div>No media folders registered yet</div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    Add your photo/video folders to enable pre-scanning and fast workspace creation
                </div>
                <button @click="showAddMediaFolderModal = true"
                        style="margin-top: 20px; background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ‚ûï Add First Media Folder
                </button>
            </div>
            
            <div v-if="loadingMedia" class="loading">
                <div class="spinner"></div>
                <div>Loading media folders...</div>
            </div>
            
            <!-- Media Folders Grid -->
            <div v-if="mediaFolders.length > 0" style="display: grid; gap: 20px;">
                <div v-for="folder in mediaFolders" :key="folder.path"
                     style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; border: 2px solid rgba(255,255,255,0.1);"
                     :style="{ borderColor: !isFolderAvailable(folder) ? 'rgba(239, 68, 68, 0.5)' : 'rgba(255,255,255,0.1)' }">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <h3 style="font-size: 1.2rem; margin: 0;">{{ folder.name }}</h3>
                                <span style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.1);"
                                      :style="{ background: getCategoryColor(folder.category) }">
                                    {{ getCategoryIcon(folder.category) }} {{ folder.category.toUpperCase() }}
                                </span>
                                <span v-if="!isFolderAvailable(folder)"
                                      style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; background: rgba(239, 68, 68, 0.2); color: #ef4444;">
                                    ‚ö†Ô∏è OFFLINE
                                </span>
                                <span v-if="folder.is_scanned"
                                      style="font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; background: rgba(74, 222, 128, 0.2); color: #4ade80;">
                                    ‚úì SCANNED
                                </span>
                            </div>
                            <div style="font-size: 0.85rem; color: #888; font-family: monospace; margin-bottom: 8px;">
                                {{ folder.path }}
                            </div>
                            <div v-if="folder.volume_label" style="font-size: 0.8rem; color: #666;">
                                Volume: {{ folder.volume_label }} (Serial: {{ folder.volume_serial }})
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button @click="scanMediaFolder(folder.path)"
                                    :disabled="!isFolderAvailable(folder) || isScanningFolder(folder.path)"
                                    style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;"
                                    :style="{ opacity: (!isFolderAvailable(folder) || isScanningFolder(folder.path)) ? 0.5 : 1 }">
                                {{ isScanningFolder(folder.path) ? '‚è≥ Scanning...' : 'üîç Scan' }}
                            </button>
                            <button @click="removeMediaFolder(folder.path)"
                                    style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scan Progress - ALWAYS VISIBLE DURING SCAN -->
                    <div v-if="isScanningFolder(folder.path)"
                         style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 2px solid rgba(245, 158, 11, 0.5);">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div class="spinner" style="width: 20px; height: 20px; margin-right: 10px;"></div>
                            <div style="font-weight: bold; color: #f59e0b;">Scanning in Progress...</div>
                        </div>
                        
                        <!-- Progress Info -->
                        <div v-if="scanProgress">
                            <!-- When we have total count -->
                            <div v-if="scanProgress.total > 0">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                                    <span style="color: #888;">{{ scanProgress.current_file || 'Processing...' }}</span>
                                    <span style="color: #4ade80;">{{ scanProgress.completed }} / {{ scanProgress.total }}</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, #f59e0b, #ef4444); transition: width 0.3s ease;"
                                         :style="{ width: (scanProgress.completed / scanProgress.total * 100) + '%' }">
                                    </div>
                                </div>
                                <div style="margin-top: 8px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #888;">
                                    <span>{{ scanProgress.current_analyzer || 'blur' }}</span>
                                    <span>{{ scanProgress.photos_per_second || 0 }} photos/sec</span>
                                    <span>ETA: {{ scanProgress.estimated_remaining_seconds || '?' }}s</span>
                                </div>
                            </div>
                            
                            <!-- During initialization (total = 0) -->
                            <div v-else>
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 8px;">
                                    {{ scanProgress.current_file || 'Discovering photos...' }}
                                </div>
                                <!-- Indeterminate progress bar (pulse effect) -->
                                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative;">
                                    <div style="position: absolute; height: 100%; width: 50%; background: linear-gradient(90deg, transparent, #f59e0b, #ef4444, transparent); animation: pulse-scan 1.5s ease-in-out infinite;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fallback if no progress data -->
                        <div v-else style="color: #888; font-size: 0.9rem;">
                            Initializing scan...
                        </div>
                    </div>
                    
                    <!-- Folder Stats -->
                    <div v-if="folder.is_scanned" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <div style="padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: #4ade80;">{{ folder.total_photos }}</div>
                            <div style="font-size: 0.75rem; color: #666;">Photos</div>
                        </div>
                        <div v-if="folder.scan_coverage && folder.scan_coverage.blur"
                             style="padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: #4ade80;">{{ Math.round(folder.scan_coverage.blur) }}%</div>
                            <div style="font-size: 0.75rem; color: #666;">Blur Scanned</div>
                        </div>
                        <div v-if="folder.scan_date"
                             style="padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.85rem; color: #888;">{{ formatDate(folder.scan_date) }}</div>
                            <div style="font-size: 0.75rem; color: #666;">Last Scan</div>
                        </div>
                    </div>
                    
                    <div v-if="folder.notes" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.85rem; color: #888; border-left: 3px solid #4ade80;">
                        {{ folder.notes }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All Photos View -->
        <div v-if="currentView === 'photos'">
            <!-- Action Bar -->
            <div v-if="photos.length > 0" style="display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 10px;">
                <button @click="resetAllRatings"
                        style="background: rgba(239, 68, 68, 0.2); border: 2px solid rgba(239, 68, 68, 0.5); color: #ef4444; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                    üóëÔ∏è Reset All Ratings
                </button>
                <button @click="resetAllColors"
                        style="background: rgba(239, 68, 68, 0.2); border: 2px solid rgba(239, 68, 68, 0.5); color: #ef4444; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                    üóëÔ∏è Reset All Colors
                </button>
            </div>
            
            <!-- Filter Bar -->
            <div v-if="photos.length > 0" class="filter-bar">
                <div class="filter-section">
                    <div class="filter-label">‚≠ê Rating</div>
                    <div class="filter-options">
                        <label class="filter-chip" :class="{ active: filters.ratings[0] }">
                            <input type="checkbox" v-model="filters.ratings[0]">
                            ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ Unrated
                        </label>
                        <label class="filter-chip" :class="{ active: filters.ratings[1] }">
                            <input type="checkbox" v-model="filters.ratings[1]">
                            ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ 1-Star
                        </label>
                        <label class="filter-chip" :class="{ active: filters.ratings[2] }">
                            <input type="checkbox" v-model="filters.ratings[2]">
                            ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ 2-Star
                        </label>
                        <label class="filter-chip" :class="{ active: filters.ratings[3] }">
                            <input type="checkbox" v-model="filters.ratings[3]">
                            ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ 3-Star
                        </label>
                        <label class="filter-chip" :class="{ active: filters.ratings[4] }">
                            <input type="checkbox" v-model="filters.ratings[4]">
                            ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 4-Star
                        </label>
                        <label class="filter-chip" :class="{ active: filters.ratings[5] }">
                            <input type="checkbox" v-model="filters.ratings[5]">
                            ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5-Star
                        </label>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-label">üé® Color Labels</div>
                    <div class="filter-options">
                        <label class="filter-chip" :class="{ active: filters.colors.red }">
                            <input type="checkbox" v-model="filters.colors.red">
                            üî¥ Red
                        </label>
                        <label class="filter-chip" :class="{ active: filters.colors.yellow }">
                            <input type="checkbox" v-model="filters.colors.yellow">
                            üü° Yellow
                        </label>
                        <label class="filter-chip" :class="{ active: filters.colors.green }">
                            <input type="checkbox" v-model="filters.colors.green">
                            üü¢ Green
                        </label>
                        <label class="filter-chip" :class="{ active: filters.colors.blue }">
                            <input type="checkbox" v-model="filters.colors.blue">
                            üîµ Blue
                        </label>
                        <label class="filter-chip" :class="{ active: filters.colors.purple }">
                            <input type="checkbox" v-model="filters.colors.purple">
                            üü£ Purple
                        </label>
                        <label class="filter-chip" :class="{ active: filters.colors.none }">
                            <input type="checkbox" v-model="filters.colors.none">
                            ‚ö™ No Color
                        </label>
                    </div>
                </div>
                
                <div class="filter-section" v-if="allKeywords.length > 0">
                    <div class="filter-label">üè∑Ô∏è Keywords</div>
                    <div class="keyword-filter-chips">
                        <div v-for="kw in allKeywords.slice(0, 15)" 
                             :key="kw.name"
                             class="keyword-filter-chip"
                             :class="{ active: filters.keywords.includes(kw.name) }"
                             @click="toggleKeywordFilter(kw.name)">
                            {{ kw.name }} <span class="count">({{ kw.count }})</span>
                        </div>
                        <div v-if="allKeywords.length > 15" style="color: #888; font-size: 0.85rem; padding: 6px 12px;">
                            +{{ allKeywords.length - 15 }} more
                        </div>
                    </div>
                </div>
                
                <div class="filter-section" v-if="allKeywords.length > 0">
                    <div class="filter-label">üè∑Ô∏è Keywords ({{ allKeywords.length }})</div>
                    <div class="keyword-filter-chips">
                        <span v-for="keyword in allKeywords.slice(0, 20)" 
                              :key="keyword.name"
                              class="keyword-filter-chip"
                              :class="{ active: filters.keywords.includes(keyword.name) }"
                              @click="toggleKeywordFilter(keyword.name)">
                            {{ keyword.name }}
                            <span class="count">({{ keyword.count }})</span>
                        </span>
                        <span v-if="allKeywords.length > 20" style="color: #888; font-size: 0.85rem; padding: 6px;">
                            +{{ allKeywords.length - 20 }} more...
                        </span>
                    </div>
                    <div v-if="filters.keywords.length > 0" style="margin-top: 10px; font-size: 0.85rem; color: #4ade80;">
                        Active filters: {{ filters.keywords.join(', ') }}
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-label">üîç Other Filters</div>
                    <div class="filter-options">
                        <label class="filter-chip" :class="{ active: filters.inBursts }">
                            <input type="checkbox" v-model="filters.inBursts">
                            üì∏ In Bursts
                        </label>
                        
                        <div v-if="activeFilterCount > 0" class="filter-stats">
                            {{ filteredPhotos.length }} of {{ photos.length }} photos
                        </div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-label">üìä Sort By</div>
                    <div class="sort-controls">
                        <select v-model="sortBy" class="sort-select">
                            <option value="name">Name</option>
                            <option value="rating">Rating</option>
                            <option value="date">Date</option>
                        </select>
                        
                        <button class="sort-order-btn" @click="sortOrder = sortOrder === 'asc' ? 'desc' : 'asc'">
                            {{ sortOrder === 'asc' ? '‚Üë' : '‚Üì' }}
                        </button>
                        
                        <button v-if="activeFilterCount > 0" 
                                @click="clearFilters"
                                style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); color: #f87171; margin-left: 10px;"
                                class="sort-order-btn">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Blur Detection Section -->
            <div v-if="blurScores.length > 0" style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                    <h3 style="font-size: 1.2rem; margin: 0;">üîç Blur Threshold</h3>
                    
                    <!-- Method Selector -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #888; font-size: 0.9rem;">Method:</label>
                        <select v-model="blurDetectionMethod" @change="onBlurMethodChange"
                                style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                            <option value="laplacian" style="background: #1a1a1a;">Laplacian (Fast)</option>
                            <option value="tenengrad" style="background: #1a1a1a;">Tenengrad (Sky-friendly)</option>
                            <option value="roi" style="background: #1a1a1a;">ROI (Adaptive)</option>
                        </select>
                    </div>
                    
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer;">
                        <input type="checkbox" v-model="blurThresholdEnabled" style="width: 18px; height: 18px;">
                        Enable Auto-Flagging
                    </label>
                </div>
                
                <!-- Method Info -->
                <div v-if="blurMethodInfo[blurDetectionMethod]" 
                     style="padding: 10px 15px; background: rgba(74, 222, 128, 0.1); border-radius: 6px; border: 1px solid rgba(74, 222, 128, 0.2); margin-bottom: 15px;">
                    <div style="font-size: 0.85rem; color: #4ade80;">
                        <strong>{{ blurMethodInfo[blurDetectionMethod].name }}</strong> - 
                        Range: {{ blurMethodInfo[blurDetectionMethod].range }} - 
                        {{ blurMethodInfo[blurDetectionMethod].desc }}
                    </div>
                </div>
                
                <!-- Threshold Slider -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="color: #888; font-size: 0.9rem;">
                            Threshold: {{ blurThresholdValue }} 
                            <span style="font-size: 0.8rem; color: #666;">
                                ({{ blurThresholdValue === 0 ? 'Disabled' : blurThresholdValue < 20 ? 'Extremely Strict' : blurThresholdValue < 50 ? 'Very Strict' : blurThresholdValue < 100 ? 'Strict' : blurThresholdValue < 150 ? 'Balanced' : blurThresholdValue < 200 ? 'Lenient' : 'Very Lenient' }})
                            </span>
                        </label>
                        <button @click="applyBlurThreshold" 
                                :disabled="!blurThresholdEnabled || applyingThreshold"
                                style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;"
                                :style="{ opacity: (!blurThresholdEnabled || applyingThreshold) ? 0.5 : 1 }">
                            {{ applyingThreshold ? '‚è≥ Applying...' : 'üö© Apply Threshold' }}
                        </button>
                    </div>
                    <input type="range" v-model.number="blurThresholdValue" 
                           :min="0" :max="getThresholdMax()" :step="getThresholdStep()"
                           style="width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; outline: none;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #666; margin-top: 4px;">
                        <span>0 (None)</span>
                        <span>Photos below {{ blurThresholdValue }} will be flagged</span>
                        <span>{{ getThresholdMax() }} (All)</span>
                    </div>
                </div>
                
                <!-- Blur Histogram -->
                <div v-if="blurHistogram" style="padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <h4 style="font-size: 1rem; margin-bottom: 15px; color: #888;">Blur Score Distribution</h4>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <div v-for="(count, range) in blurHistogram" :key="range"
                             style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px;"
                             :style="{ 
                                 borderBottom: shouldRangeBeBlurred(range) ? '3px solid #ef4444' : '3px solid transparent'
                             }">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #4ade80;">{{ count }}</div>
                            <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">{{ range }}</div>
                            <div v-if="shouldRangeBeBlurred(range)" 
                                 style="font-size: 0.7rem; color: #ef4444; margin-top: 4px;">
                                üö© Flagged
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(74, 222, 128, 0.1); border-radius: 6px; border: 1px solid rgba(74, 222, 128, 0.2);">
                        <div style="color: #4ade80; font-size: 0.85rem;">
                            ‚ÑπÔ∏è {{ blurScores.length }} photos have blur scores. Adjust threshold slider to flag blurry photos.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calculate Blur Scores Button -->
            <div v-if="photos.length > 0 && blurScores.length === 0" 
                 style="margin: 20px 0; padding: 30px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 12px; border: 2px dashed rgba(255,255,255,0.2);">
                <div style="font-size: 2rem; margin-bottom: 15px;">üîç</div>
                <h3 style="font-size: 1.2rem; margin-bottom: 10px;">Blur Detection Not Run</h3>
                <p style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">
                    Calculate blur scores once, then adjust threshold slider to flag blurry photos
                </p>
                
                <!-- Method Selector -->
                <div style="margin-bottom: 20px;">
                    <select v-model="blurDetectionMethod"
                            style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                        <option value="laplacian" style="background: #1a1a1a;">Laplacian (Fast, general)</option>
                        <option value="tenengrad" style="background: #1a1a1a;">Tenengrad (Better for sky)</option>
                        <option value="roi" style="background: #1a1a1a;">ROI (Adaptive, ignores sky)</option>
                    </select>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: #666;">
                        {{ blurMethodInfo[blurDetectionMethod].desc }}
                    </div>
                </div>
                
                <button @click="runBlurDetection"
                        :disabled="blurDetectionRunning"
                        style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;"
                        :style="{ opacity: blurDetectionRunning ? 0.5 : 1 }">
                    {{ blurDetectionRunning ? '‚è≥ Calculating...' : 'üîç Calculate Blur Scores (' + blurDetectionMethod.toUpperCase() + ')' }}
                </button>
                
                <!-- Progress Bar -->
                <div v-if="blurDetectionProgress && blurDetectionProgress.status === 'running'" 
                     style="margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem;">
                        <span style="color: #888;">{{ blurDetectionProgress.current_file }}</span>
                        <span style="color: #4ade80;">{{ blurDetectionProgress.progress }} / {{ blurDetectionProgress.total }}</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #f59e0b, #ef4444); transition: width 0.3s ease;"
                             :style="{ width: (blurDetectionProgress.progress / blurDetectionProgress.total * 100) + '%' }">
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="loading && photos.length === 0" class="loading">
                <div class="spinner"></div>
                <div>Loading photos...</div>
            </div>
            
            <div v-if="error" class="error">
                <strong>Error:</strong> {{ error }}
            </div>
            
            <div v-if="filteredPhotos.length > 0" class="grid">
                <div v-for="(photo, index) in filteredPhotos" 
                     :key="photo.id" 
                     class="photo-card"
                     @mouseenter="hoveredPhoto = photo.id"
                     @mouseleave="hoveredPhoto = null; hoverStar = 0"
                     @click="openLightbox(photo, index)">
                    
                    <img :src="photo.thumbnail" 
                         :alt="photo.name"
                         @error="handleImageError($event, photo)"
                         loading="lazy">
                    
                    <!-- Color Label Badge (top-left) -->
                    <div v-if="photo.color" 
                         class="color-label-badge"
                         :class="photo.color"
                         :style="{ background: getColorHex(photo.color) }">
                    </div>
                    
                    <!-- Burst Badge (top-right) -->
                    <div v-if="photo.burst && photo.burst.is_burst"
                         style="position: absolute; top: 8px; right: 8px; background: rgba(251, 191, 36, 0.9); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; backdrop-filter: blur(4px);"
                         :title="`Burst group (${photo.burst.group_size} photos)`">
                        üì∏ {{ photo.burst.group_size }}
                    </div>
                    
                    <div class="photo-info">
                        <div class="photo-name" :title="photo.name">{{ photo.name }}</div>
                        <div v-if="photo.capture_time" style="font-size: 0.7rem; color: #888; margin-top: 2px;">
                            {{ formatCaptureTime(photo.capture_time) }}
                        </div>
                        
                        <!-- Blur Score Display -->
                        <div v-if="getPhotoBlurScore(photo) !== null" 
                             style="font-size: 0.75rem; margin-top: 4px; padding: 4px 8px; background: rgba(255,255,255,0.1); border-radius: 4px; display: inline-block; font-weight: 600;"
                             :style="{ 
                                 color: getBlurScoreColor(getPhotoBlurScore(photo)),
                                 borderLeft: '3px solid ' + getBlurScoreColor(getPhotoBlurScore(photo))
                             }"
                             :title="getBlurScoreTooltip(photo)">
                            üîç {{ Math.round(getPhotoBlurScore(photo)) }} 
                            <span style="font-size: 0.65rem; opacity: 0.7;">{{ blurDetectionMethod.substring(0, 3).toUpperCase() }}</span>
                        </div>
                        
                        <div class="stars" @click.stop>
                            <span v-for="n in 5" 
                                  :key="n" 
                                  class="star" 
                                  :class="{ 
                                      active: n <= photo.rating,
                                      hover: hoveredPhoto === photo.id && n <= hoverStar
                                  }"
                                  @mouseenter="hoverStar = n"
                                  @click="rate(photo, n)">
                                ‚òÖ
                            </span>
                        </div>
                        
                        <!-- Color Labels UI -->
                        <div class="color-labels" @click.stop>
                            <span class="color-dot red" 
                                  :class="{ active: photo.color === 'red' }"
                                  @click="setColor(photo, photo.color === 'red' ? null : 'red')"
                                  title="Red Label">
                                {{ photo.color === 'red' ? '‚úì' : '' }}
                            </span>
                            <span class="color-dot yellow" 
                                  :class="{ active: photo.color === 'yellow' }"
                                  @click="setColor(photo, photo.color === 'yellow' ? null : 'yellow')"
                                  title="Yellow Label">
                                {{ photo.color === 'yellow' ? '‚úì' : '' }}
                            </span>
                            <span class="color-dot green" 
                                  :class="{ active: photo.color === 'green' }"
                                  @click="setColor(photo, photo.color === 'green' ? null : 'green')"
                                  title="Green Label">
                                {{ photo.color === 'green' ? '‚úì' : '' }}
                            </span>
                            <span class="color-dot blue" 
                                  :class="{ active: photo.color === 'blue' }"
                                  @click="setColor(photo, photo.color === 'blue' ? null : 'blue')"
                                  title="Blue Label">
                                {{ photo.color === 'blue' ? '‚úì' : '' }}
                            </span>
                            <span class="color-dot purple" 
                                  :class="{ active: photo.color === 'purple' }"
                                  @click="setColor(photo, photo.color === 'purple' ? null : 'purple')"
                                  title="Purple Label">
                                {{ photo.color === 'purple' ? '‚úì' : '' }}
                            </span>
                        </div>
                        
                        <!-- Keywords UI -->
                        <div class="keywords-container" @click.stop>
                            <span v-for="keyword in (photo.keywords || [])" 
                                  :key="keyword"
                                  class="keyword-tag"
                                  :title="'Remove: ' + keyword">
                                {{ keyword }}
                                <span class="remove" @click="removeKeyword(photo, keyword)">√ó</span>
                            </span>
                            
                            <!-- Add keyword button/input -->
                            <span v-if="showKeywordInput === photo.id" class="keyword-input-wrapper">
                                <input type="text" 
                                       class="keyword-input"
                                       v-model="keywordInput"
                                       @keyup.enter="addKeyword(photo, keywordInput)"
                                       @keyup.esc="showKeywordInput = null; keywordInput = ''"
                                       @blur="showKeywordInput = null; keywordInput = ''"
                                       placeholder="tag..."
                                       autofocus>
                                
                                <!-- Autocomplete suggestions -->
                                <div v-if="keywordSuggestionsFiltered.length > 0" 
                                     class="keyword-suggestions"
                                     @mousedown.prevent>
                                    <div v-for="suggestion in keywordSuggestionsFiltered"
                                         :key="suggestion.name"
                                         class="keyword-suggestion"
                                         @click="addKeyword(photo, suggestion.name)">
                                        {{ suggestion.name }}
                                        <span class="count">({{ suggestion.count }})</span>
                                    </div>
                                </div>
                            </span>
                            
                            <span v-else 
                                  class="add-keyword-btn"
                                  @click="showKeywordInput = photo.id; keywordInput = ''">
                                + tag
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="photos.length > 0 && filteredPhotos.length === 0" class="loading">
                <div style="font-size: 3rem; margin-bottom: 20px;">üîç</div>
                <div>No photos match your filters</div>
                <div style="margin-top: 15px;">
                    <button @click="clearFilters" 
                            style="background: rgba(74, 222, 128, 0.2); border: 2px solid rgba(74, 222, 128, 0.5); color: #4ade80; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        Clear All Filters
                    </button>
                </div>
            </div>
            
            <div v-if="photos.length > 0 && photos.length < totalPhotos && filteredPhotos.length > 0" class="load-more">
                <button @click="loadMore" :disabled="loading">
                    {{ loading ? 'Loading...' : `Load More (${totalPhotos - photos.length} remaining)` }}
                </button>
            </div>
        </div>
        
        <!-- Bursts View -->
        <div v-if="currentView === 'bursts'">
            <!-- Progress indicator -->
            <div v-if="burstProgress.show && loadingBursts" 
                 style="background: rgba(74, 222, 128, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid rgba(74, 222, 128, 0.3);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="font-weight: 600;">{{ burstProgress.message }}</span>
                    <span v-if="burstProgress.total > 0">{{ burstProgress.progress }} / {{ burstProgress.total }}</span>
                </div>
                <div style="background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #4ade80, #3b82f6); height: 100%; transition: width 0.3s ease;"
                         :style="{ width: burstProgress.total > 0 ? (burstProgress.progress / burstProgress.total * 100) + '%' : '0%' }">
                    </div>
                </div>
            </div>
            
            <div v-if="loadingBursts && !burstProgress.show" class="loading">
                <div class="spinner"></div>
                <div>Analyzing bursts...</div>
            </div>
            
            <!-- Cache indicator & Reanalyze button -->
            <div v-if="!loadingBursts && bursts.length > 0" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                <div v-if="burstsFromCache" style="background: rgba(74, 222, 128, 0.1); padding: 10px 15px; border-radius: 8px; font-size: 0.9rem;">
                    ‚úì Loaded from cache
                </div>
                <button @click="loadBursts(true)" 
                        style="background: rgba(74, 222, 128, 0.2); border: 2px solid rgba(74, 222, 128, 0.5); color: #4ade80; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    üîÑ Reanalyze
                </button>
            </div>
            
            <div v-if="burstError" class="error">
                <strong>Error:</strong> {{ burstError }}
            </div>
            
            <div v-if="bursts.length === 0 && !loadingBursts" class="loading">
                <div style="font-size: 3rem; margin-bottom: 20px;">üì∏</div>
                <div>No burst groups found</div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    Bursts are groups of similar photos taken in quick succession
                </div>
            </div>
            
            <div v-if="bursts.length > 0" class="grid">
                <div v-for="burst in bursts" 
                     :key="burst.id" 
                     class="burst-card"
                     @click="openBurstViewer(burst)">
                    
                    <div class="burst-header">
                        <div class="burst-name">{{ burst.name }}</div>
                        <div class="burst-count">{{ burst.count }} photos</div>
                    </div>
                    
                    <div class="burst-thumbnails">
                        <div v-for="(photo, idx) in burst.photos.slice(0, 4)" 
                             :key="photo.id"
                             class="burst-thumb-wrapper">
                            <img :src="photo.thumbnail" 
                                 :alt="photo.name"
                                 class="burst-thumb">
                            <div v-if="photo.is_best" class="best-badge">BEST</div>
                            <div v-if="photo.blur_score" 
                                 class="blur-badge"
                                 :class="getBlurClass(photo.blur_score)">
                                {{ Math.round(photo.blur_score) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Projects View -->
        <div v-if="currentView === 'projects'">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-size: 1.5rem; margin: 0;">üìÅ Projects</h2>
                <button @click="showNewProjectModal = true"
                        style="background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    ‚ú® New Project
                </button>
            </div>
            
            <div v-if="loadingProjects" class="loading">
                <div class="spinner"></div>
                <div>Loading projects...</div>
            </div>
            
            <div v-if="projectError" class="error">
                <strong>Error:</strong> {{ projectError }}
            </div>
            
            <div v-if="projects.length === 0 && !loadingProjects" class="loading">
                <div style="font-size: 3rem; margin-bottom: 20px;">üìÅ</div>
                <div>No projects yet</div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    Create a project to save photo selections and export settings
                </div>
                <button @click="showNewProjectModal = true"
                        style="margin-top: 20px; background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ‚ú® Create First Project
                </button>
            </div>
            
            <!-- Project Cards -->
            <div v-if="projects.length > 0" class="grid">
                <div v-for="project in projects" 
                     :key="project.id" 
                     class="project-card">
                    
                    <div class="project-header">
                        <div class="project-name">{{ project.name }}</div>
                        <div class="project-meta">
                            <span>üìä {{ project.photo_count || 0 }} photos</span>
                            <span v-if="project.has_music">üéµ</span>
                        </div>
                    </div>
                    
                    <div class="project-info">
                        <div style="font-size: 0.85rem; color: #888;">
                            <div>Created: {{ formatDate(project.created) }}</div>
                            <div v-if="project.updated !== project.created">
                                Updated: {{ formatDate(project.updated) }}
                            </div>
                            <div v-if="project.export_count > 0">
                                Exports: {{ project.export_count }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="project-actions">
                        <button @click="loadProject(project.id)" 
                                class="project-btn primary">
                            üìÇ Load
                        </button>
                        <button @click="exportProject(project.id)" 
                                class="project-btn">
                            üì§ Export
                        </button>
                        <button @click="editProject(project.id)" 
                                class="project-btn">
                            ‚úèÔ∏è Edit
                        </button>
                        <button @click="confirmDeleteProject(project.id)" 
                                class="project-btn danger">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quality Detection Section -->
            <div v-if="currentProjectId" style="margin-top: 40px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 12px;">
                <h2 style="font-size: 1.5rem; margin-bottom: 20px;">‚ú® Quality Detection Settings</h2>
                <p style="color: #888; margin-bottom: 25px; font-size: 0.9rem;">
                    Configure blur and burst detection parameters for this project. These settings affect photo selection and gallery exports.
                </p>
                
                <!-- Blur Detection Section -->
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        üîç Blur Detection
                        <label style="margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: normal;">
                            <input type="checkbox" v-model="qualitySettings.blur_detection_enabled" style="width: 18px; height: 18px;">
                            Enabled
                        </label>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #888; font-size: 0.9rem;">
                                Blur Threshold ({{ qualitySettings.blur_threshold }})
                            </label>
                            <input type="range" v-model.number="qualitySettings.blur_threshold" 
                                   min="50" max="200" step="5"
                                   style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #666; margin-top: 4px;">
                                <span>50 (Strict)</span>
                                <span>200 (Lenient)</span>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #888; font-size: 0.9rem;">
                                Auto-flag Color
                            </label>
                            <select v-model="qualitySettings.blur_auto_flag_color"
                                    style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                                <option value="red" style="background: #1a1a1a;">üî¥ Red</option>
                                <option value="yellow" style="background: #1a1a1a;">üü° Yellow</option>
                                <option value="blue" style="background: #1a1a1a;">üîµ Blue</option>
                                <option value="purple" style="background: #1a1a1a;">üü£ Purple</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Blur Detection Action -->
                    <div style="margin-top: 20px;">
                        <div style="padding: 15px; background: rgba(74, 222, 128, 0.1); border-radius: 6px; border: 1px solid rgba(74, 222, 128, 0.2); margin-bottom: 15px;">
                            <div style="color: #4ade80; font-size: 0.9rem; margin-bottom: 8px;">
                                ‚ÑπÔ∏è <strong>Blur Detection Workflow:</strong>
                            </div>
                            <div style="color: #888; font-size: 0.85rem;">
                                1. Select detection method (Laplacian, Tenengrad, or ROI)<br>
                                2. Calculate blur scores once for all photos<br>
                                3. Go to Photos tab and adjust threshold slider to flag blurry photos<br>
                                4. Compare methods by calculating with different methods!
                            </div>
                        </div>
                        
                        <!-- Method Selector -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #888; font-size: 0.9rem;">
                                Detection Method:
                            </label>
                            <select v-model="blurDetectionMethod"
                                    style="width: 100%; max-width: 400px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                                <option value="laplacian" style="background: #1a1a1a;">Laplacian Variance (Fast, 0-300)</option>
                                <option value="tenengrad" style="background: #1a1a1a;">Tenengrad/Sobel (Better for sky, 0-50)</option>
                                <option value="roi" style="background: #1a1a1a;">ROI-based (Adaptive, ignores sky, 0-300)</option>
                            </select>
                            <div style="margin-top: 8px; font-size: 0.8rem; color: #666;">
                                {{ blurMethodInfo[blurDetectionMethod].desc }}
                            </div>
                        </div>
                        
                        <button @click="runBlurDetection"
                                :disabled="blurDetectionRunning || !qualitySettings.blur_detection_enabled"
                                style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.2s;"
                                :style="{ opacity: (blurDetectionRunning || !qualitySettings.blur_detection_enabled) ? 0.5 : 1 }">
                            {{ blurDetectionRunning ? '‚è≥ Calculating...' : 'üîç Calculate Blur Scores (' + blurDetectionMethod.toUpperCase() + ')' }}
                        </button>
                        
                        <!-- Progress Bar (Projects Tab) -->
                        <div v-if="blurDetectionProgress && blurDetectionProgress.status === 'running'" 
                             style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; max-width: 600px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                                <span style="color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%;">
                                    üìÑ {{ blurDetectionProgress.current_file }}
                                </span>
                                <span style="color: #4ade80; font-weight: 600;">
                                    {{ blurDetectionProgress.progress }} / {{ blurDetectionProgress.total }}
                                </span>
                            </div>
                            <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #f59e0b, #ef4444); transition: width 0.3s ease;"
                                     :style="{ width: blurDetectionProgress.total > 0 ? (blurDetectionProgress.progress / blurDetectionProgress.total * 100) + '%' : '0%' }">
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85rem; color: #888; text-align: center;">
                                {{ blurDetectionProgress.message }}
                            </div>
                        </div>
                        
                        <div v-if="blurScores.length > 0 && (!blurDetectionProgress || blurDetectionProgress.status !== 'running')" 
                             style="margin-top: 10px; font-size: 0.85rem; color: #4ade80;">
                            ‚úì {{ blurScores.length }} photos have blur scores. Go to Photos tab to adjust threshold.
                        </div>
                    </div>
                </div>
                
                <!-- Burst Detection Section -->
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                    <h3 style="font-size: 1.2rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        üì¶ Burst Detection
                        <label style="margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: normal;">
                            <input type="checkbox" v-model="qualitySettings.burst_detection_enabled" style="width: 18px; height: 18px;">
                            Enabled
                        </label>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #888; font-size: 0.9rem;">
                                Time Threshold ({{ qualitySettings.burst_time_threshold }}s)
                            </label>
                            <input type="range" v-model.number="qualitySettings.burst_time_threshold" 
                                   min="1" max="10" step="1"
                                   style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none;">
                            <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">
                                Max seconds between photos in a burst
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #888; font-size: 0.9rem;">
                                Similarity Threshold ({{ (qualitySettings.burst_similarity_threshold * 100).toFixed(0) }}%)
                            </label>
                            <input type="range" v-model.number="qualitySettings.burst_similarity_threshold" 
                                   min="0.80" max="0.99" step="0.01"
                                   style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none;">
                            <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">
                                Minimum similarity for burst grouping
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-radius: 6px; border: 1px solid rgba(74, 222, 128, 0.2);">
                        <div style="color: #4ade80; font-size: 0.9rem;">
                            ‚ÑπÔ∏è Burst detection is currently running automatically. Settings will be applied on next scan.
                        </div>
                    </div>
                </div>
                
                <!-- Save Settings Button -->
                <div style="margin-top: 20px; text-align: right;">
                    <button @click="saveQualitySettings"
                            style="background: linear-gradient(135deg, #4ade80, #3b82f6); color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        üíæ Save Settings
                    </button>
                </div>
            </div>
            
            <div v-if="!currentProjectId && projects.length > 0" 
                 style="margin-top: 40px; padding: 40px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 12px; border: 2px dashed rgba(255,255,255,0.2);">
                <div style="font-size: 2rem; margin-bottom: 15px;">üìÅ</div>
                <div style="font-size: 1.1rem; color: #888;">
                    Select a project from the dropdown above to configure quality detection settings
                </div>
            </div>
        </div>
        
        <!-- Lightbox -->
        <div v-if="showLightbox && lightboxPhoto" class="lightbox" @click.self="closeLightbox">
            <div class="lightbox-header">
                <div class="lightbox-title">
                    {{ lightboxPhoto.name }} ({{ lightboxIndex + 1 }} / {{ filteredPhotos.length }})
                </div>
                <div class="lightbox-controls">
                    <button class="lightbox-btn" @click="closeLightbox" title="Close (ESC)">√ó</button>
                </div>
            </div>
            
            <div class="lightbox-main">
                <img :src="lightboxPhoto.full_image || lightboxPhoto.thumbnail" 
                     :alt="lightboxPhoto.name" 
                     class="lightbox-image">
                
                <button class="lightbox-nav prev" 
                        @click="prevPhoto" 
                        :disabled="lightboxIndex === 0"
                        title="Previous (‚Üê)">
                    ‚Äπ
                </button>
                
                <button class="lightbox-nav next" 
                        @click="nextPhoto" 
                        :disabled="lightboxIndex === filteredPhotos.length - 1"
                        title="Next (‚Üí)">
                    ‚Ä∫
                </button>
                
                <div class="keyboard-shortcuts">
                    <div><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate</div>
                    <div><kbd>1-5</kbd> Quick rating</div>
                    <div><kbd>C</kbd> Color label</div>
                    <div><kbd>ESC</kbd> Close</div>
                </div>
            </div>
            
            <div class="lightbox-sidebar">
                <div class="lightbox-metadata">
                    <div class="lightbox-rating">
                        <span style="color: #888; margin-right: 10px;">Rating:</span>
                        <span v-for="n in 5" 
                              :key="n" 
                              class="lightbox-star" 
                              :class="{ active: n <= lightboxPhoto.rating }"
                              @mouseenter="hoverStar = n"
                              @mouseleave="hoverStar = 0"
                              @click="rateLightboxPhoto(n)">
                            ‚òÖ
                        </span>
                    </div>
                    
                    <div class="lightbox-colors">
                        <span style="color: #888; margin-right: 10px;">Color:</span>
                        <span class="lightbox-color-dot red" 
                              :class="{ active: lightboxPhoto.color === 'red' }"
                              @click="setColor(lightboxPhoto, lightboxPhoto.color === 'red' ? null : 'red')"
                              :style="{ background: '#ef4444' }">
                        </span>
                        <span class="lightbox-color-dot yellow" 
                              :class="{ active: lightboxPhoto.color === 'yellow' }"
                              @click="setColor(lightboxPhoto, lightboxPhoto.color === 'yellow' ? null : 'yellow')"
                              :style="{ background: '#fbbf24' }">
                        </span>
                        <span class="lightbox-color-dot green" 
                              :class="{ active: lightboxPhoto.color === 'green' }"
                              @click="setColor(lightboxPhoto, lightboxPhoto.color === 'green' ? null : 'green')"
                              :style="{ background: '#4ade80' }">
                        </span>
                        <span class="lightbox-color-dot blue" 
                              :class="{ active: lightboxPhoto.color === 'blue' }"
                              @click="setColor(lightboxPhoto, lightboxPhoto.color === 'blue' ? null : 'blue')"
                              :style="{ background: '#3b82f6' }">
                        </span>
                        <span class="lightbox-color-dot purple" 
                              :class="{ active: lightboxPhoto.color === 'purple' }"
                              @click="setColor(lightboxPhoto, lightboxPhoto.color === 'purple' ? null : 'purple')"
                              :style="{ background: '#a855f7' }">
                        </span>
                    </div>
                    
                    <div v-if="lightboxPhoto.keywords && lightboxPhoto.keywords.length > 0">
                        <div style="color: #888; margin-bottom: 8px;">Tags:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            <span v-for="keyword in lightboxPhoto.keywords" 
                                  :key="keyword"
                                  class="keyword-tag">
                                {{ keyword }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Slideshow Modal -->
        <div v-if="showSlideshow" 
             class="slideshow" 
             :class="{ 'hide-controls': hideControls }"
             @mousemove="showControlsTemporarily"
             @click="showControlsTemporarily">
            <div class="slideshow-header">
                <div class="slideshow-title">
                    <span>üé¨</span>
                    <span>Slideshow</span>
                    <span style="color: #888; font-size: 0.9rem; margin-left: 10px;">
                        {{ slideshowIndex + 1 }} / {{ slideshowPhotos.length }}
                    </span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="slideshow-btn" @click="toggleFullscreen" :title="isFullscreen ? 'Exit Fullscreen (F)' : 'Fullscreen (F)'">
                        {{ isFullscreen ? '‚õ∂ Exit Fullscreen' : '‚õ∂ Fullscreen' }}
                    </button>
                    <button class="slideshow-btn" @click="exitSlideshow" title="Exit (ESC)">
                        ‚ùå Exit
                    </button>
                </div>
            </div>
            
            <div class="slideshow-main" @click="toggleSlideshowPlay">
                <div v-for="(photo, index) in slideshowPhotos" 
                     :key="photo.id"
                     class="slideshow-image-container"
                     :class="{ active: index === slideshowIndex }">
                    <img :src="photo.full_image || photo.thumbnail" 
                         :alt="photo.name" 
                         class="slideshow-image">
                </div>
            </div>
            
            <div class="slideshow-footer">
                <div class="slideshow-progress">
                    <div class="slideshow-progress-bar">
                        <div class="slideshow-progress-fill" 
                             :style="{ width: ((slideshowIndex + 1) / slideshowPhotos.length * 100) + '%' }">
                        </div>
                    </div>
                    <div class="slideshow-progress-text">
                        {{ slideshowIndex + 1 }} / {{ slideshowPhotos.length }}
                    </div>
                </div>
                
                <div class="slideshow-controls">
                    <button class="slideshow-btn" @click="prevSlide" :disabled="slideshowIndex === 0" title="Previous (‚Üê)">
                        ‚èÆÔ∏è Prev
                    </button>
                    
                    <button class="slideshow-btn primary" @click="toggleSlideshowPlay" title="Play/Pause (Space)">
                        {{ slideshowPlaying ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play' }}
                    </button>
                    
                    <button class="slideshow-btn" @click="nextSlide" :disabled="slideshowIndex === slideshowPhotos.length - 1" title="Next (‚Üí)">
                        Next ‚è≠Ô∏è
                    </button>
                    
                    <div class="slideshow-settings">
                        <div class="slideshow-setting">
                            <span>Speed:</span>
                            <select v-model="slideshowSettings.duration" @change="restartSlideshowIfPlaying">
                                <option :value="2">2s</option>
                                <option :value="3">3s</option>
                                <option :value="5">5s</option>
                                <option :value="7">7s</option>
                                <option :value="10">10s</option>
                            </select>
                        </div>
                        
                        <div class="slideshow-setting">
                            <input type="checkbox" 
                                   id="slideshow-loop" 
                                   v-model="slideshowSettings.loop">
                            <label for="slideshow-loop">Loop</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Workspaces View -->
        <div v-if="currentView === 'workspaces'">
            <h2 style="font-size: 1.5rem; margin-bottom: 30px;">üóÇÔ∏è Workspace & Folder Management</h2>
            
            <!-- Current Workspace Info -->
            <div style="background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 15px;">
                    Current Workspace
                </div>
                <div style="font-size: 1rem; color: #aaa; margin-bottom: 10px;">
                    {{ currentWorkspace || 'No workspace selected' }}
                </div>
                <div v-if="workspaceFolders.length > 0" style="font-size: 0.9rem; color: #888;">
                    {{ workspaceFolders.filter(f => f.enabled).length }} of {{ workspaceFolders.length }} folders active
                    | {{ totalActivePhotos }} photos
                </div>
            </div>
            
            <!-- Media Folders -->
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 1.2rem; margin: 0;">üìÅ Media Folders</h3>
                    <button @click="showAddFolderModal = true"
                            style="background: rgba(74, 222, 128, 0.2); border: 2px solid rgba(74, 222, 128, 0.5); color: #4ade80; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                        + Add Folder
                    </button>
                </div>
                
                <div v-if="loadingFolders" class="loading">
                    <div class="spinner"></div>
                    <div>Loading folders...</div>
                </div>
                
                <div v-if="workspaceFolders.length === 0 && !loadingFolders" class="loading">
                    <div style="font-size: 2rem; margin-bottom: 15px;">üìÅ</div>
                    <div>No folders configured</div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        Add media folders to start scanning photos
                    </div>
                </div>
                
                <!-- Folder List -->
                <div v-if="workspaceFolders.length > 0" style="display: flex; flex-direction: column; gap: 12px;">
                    <div v-for="folder in workspaceFolders" 
                         :key="folder.path"
                         style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; transition: all 0.3s;"
                         :style="{ 
                             borderColor: folder.enabled ? 'rgba(74, 222, 128, 0.3)' : 'rgba(255,255,255,0.1)',
                             background: folder.enabled ? 'rgba(74, 222, 128, 0.05)' : 'rgba(255,255,255,0.05)'
                         }">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                                <input type="checkbox" 
                                       :checked="folder.enabled"
                                       @change="toggleFolder(folder.path, $event.target.checked)"
                                       style="width: 24px; height: 24px; cursor: pointer; accent-color: #4ade80; margin-right: 15px;">
                                
                                <div style="flex: 1;">
                                    <div style="font-size: 1rem; font-weight: 500; margin-bottom: 5px; color: #fff;">
                                        {{ folder.path }}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #888;">
                                        <span v-if="folder.photo_count > 0">{{ folder.photo_count }} photos</span>
                                        <span v-else-if="folder.is_scanned === false">Not scanned yet</span>
                                        <span v-else>No photos found</span>
                                        <span v-if="folder.is_scanned" style="color: #4ade80; margin-left: 10px;">‚úì Scanned</span>
                                        <span v-if="!folder.exists" style="color: #ef4444; margin-left: 10px;">‚ö†Ô∏è Folder not found</span>
                                    </div>
                                </div>
                            </label>
                            
                            <div style="display: flex; gap: 8px;">
                                <button @click="removeFolder(folder.path)"
                                        style="background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                    üóëÔ∏è Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="workspaceFolders.length > 0" 
                     style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Active Folders:</span>
                        <span style="font-weight: 600; color: #4ade80;">{{ workspaceFolders.filter(f => f.enabled).length }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Inactive Folders:</span>
                        <span style="font-weight: 600; color: #888;">{{ workspaceFolders.filter(f => !f.enabled).length }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <span>Total Photos (active):</span>
                        <span style="font-weight: 600; color: #3b82f6;">{{ totalActivePhotos }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Workspace List -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 1.2rem; margin: 0;">üóÇÔ∏è All Workspaces</h3>
                    <button @click="showAddWorkspaceModal = true"
                            style="background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                        ‚ú® New Workspace
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                    <div v-for="workspace in workspaces" 
                         :key="workspace.path"
                         style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; transition: all 0.3s;"
                         :style="{ 
                             borderColor: workspace.path === currentWorkspace ? 'rgba(74, 222, 128, 0.5)' : 'rgba(255,255,255,0.1)',
                             background: workspace.path === currentWorkspace ? 'rgba(74, 222, 128, 0.1)' : 'rgba(255,255,255,0.05)'
                         }">
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">
                                {{ workspace.name }}
                                <span v-if="workspace.path === currentWorkspace" style="color: #4ade80; font-size: 0.8rem; margin-left: 8px;">‚óè ACTIVE</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #888; font-family: monospace;">
                                {{ workspace.path }}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button v-if="workspace.path !== currentWorkspace"
                                    @click="switchToWorkspace(workspace.path)"
                                    style="flex: 1; background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                Switch
                            </button>
                            <button v-else
                                    disabled
                                    style="flex: 1; background: rgba(74, 222, 128, 0.3); color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: not-allowed; font-weight: 600; font-size: 0.9rem;">
                                ‚úì Current
                            </button>
                            <button @click="confirmDeleteWorkspace(workspace)"
                                    :disabled="workspace.path === currentWorkspace"
                                    :style="{
                                        background: workspace.path === currentWorkspace ? 'rgba(239, 68, 68, 0.2)' : 'linear-gradient(135deg, #ef4444, #dc2626)',
                                        color: '#fff',
                                        border: 'none',
                                        padding: '10px 16px',
                                        borderRadius: '6px',
                                        cursor: workspace.path === currentWorkspace ? 'not-allowed' : 'pointer',
                                        fontWeight: '600',
                                        fontSize: '0.9rem'
                                    }">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- New Project Modal -->
        <div v-if="showNewProjectModal" class="modal" @click.self="showNewProjectModal = false">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">‚ú® New Project</div>
                    <button class="close-btn" @click="showNewProjectModal = false">√ó</button>
                </div>
                
                <div style="padding: 20px 0;">
                    <p style="color: #888; margin-bottom: 20px;">
                        Save current photo selection and export settings as a project.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Project Name *
                        </label>
                        <input v-model="newProjectName"
                               type="text"
                               placeholder="e.g., Vacation 2026 - Best Moments"
                               style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Selection Mode
                        </label>
                        <select v-model="newProjectMode"
                                style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; cursor: pointer;">
                            <option value="filter" style="background: #1a1a1a;">Filter (Dynamic - updates with new photos)</option>
                            <option value="explicit" style="background: #1a1a1a;">Explicit (Static - fixed photo list)</option>
                            <option value="hybrid" style="background: #1a1a1a;">Hybrid (Filter + manual adjustments)</option>
                        </select>
                    </div>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 20px;">
                        <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 8px;">Will save:</div>
                        <div style="font-size: 0.9rem;">
                            ‚úì {{ filteredPhotos.length }} photos ({{ newProjectMode }})<br>
                            ‚úì Current filters<br>
                            ‚úì Export settings<br>
                            <span v-if="exportMusicFiles.trim()">‚úì Music tracks<br></span>
                        </div>
                    </div>
                    
                    <button @click="saveNewProject" 
                            :disabled="!newProjectName.trim() || savingProject"
                            style="width: 100%; background: linear-gradient(135deg, #4ade80, #3b82f6); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s;">
                        {{ savingProject ? 'Saving...' : 'üíæ Save Project' }}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Export Modal -->
        <div v-if="showExportModal" class="modal" @click.self="showExportModal = false">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">üì¶ Export Web Gallery</div>
                    <button class="close-btn" @click="showExportModal = false">√ó</button>
                </div>
                
                <div style="padding: 20px 0;">
                    <p style="color: #888; margin-bottom: 20px;">
                        Export {{ filteredPhotos.length }} photos as a standalone HTML gallery.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Gallery Title
                        </label>
                        <input v-model="exportTitle"
                               type="text"
                               placeholder="My Photo Gallery"
                               style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Template
                        </label>
                        <select v-model="exportTemplate"
                                style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; cursor: pointer;">
                            <option value="photoswipe" style="background: #1a1a1a;">PhotoSwipe (Modern, Fullscreen)</option>
                            <option value="simple" style="background: #1a1a1a;">Simple Grid (No dependencies)</option>
                        </select>
                    </div>
                    
                    <!-- üÜï Slideshow Settings -->
                    <div style="background: rgba(138, 43, 226, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.3); margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span>üé¨</span> Slideshow Settings
                        </div>
                        
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" v-model="exportSlideshowEnabled" 
                                   style="width: 18px; height: 18px; cursor: pointer; accent-color: #8a2be2;">
                            <span style="font-size: 0.9rem;">Enable Slideshow Mode</span>
                        </label>
                        
                        <div v-if="exportSlideshowEnabled">
                            <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.85rem;">
                                Duration per Photo
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <input type="range" v-model.number="exportSlideshowDuration" 
                                       min="2" max="15" step="1"
                                       style="flex: 1; accent-color: #8a2be2;">
                                <span style="min-width: 50px; font-weight: 600;">{{ exportSlideshowDuration }}s</span>
                            </div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" v-model="exportSmartTVMode" 
                                       style="width: 18px; height: 18px; cursor: pointer; accent-color: #8a2be2;">
                                <span style="font-size: 0.85rem;">üì∫ Smart TV Mode (larger buttons)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- üÜï Music Settings -->
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span>üéµ</span> Background Music (Optional)
                        </div>
                        
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">
                            Add music file paths (MP3 recommended), one per line:
                        </p>
                        
                        <textarea v-model="exportMusicFiles"
                                  placeholder="C:/Music/track1.mp3&#10;C:/Music/track2.mp3"
                                  rows="3"
                                  style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem; font-family: monospace; resize: vertical;">
                        </textarea>
                        
                        <div style="font-size: 0.75rem; color: #666; margin-top: 8px;">
                            üí° Tip: Use absolute paths like C:/Music/song.mp3
                        </div>
                    </div>
                    
                    <div style="background: rgba(74, 222, 128, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(74, 222, 128, 0.3); margin-bottom: 20px;">
                        <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 8px;">Will export:</div>
                        <div style="font-size: 0.9rem;">
                            ‚úì {{ filteredPhotos.length }} photos<br>
                            ‚úì Ratings & Color Labels<br>
                            ‚úì Keywords/Tags<br>
                            ‚úì Optimized images<br>
                            ‚úì Standalone HTML file<br>
                            <span v-if="exportSlideshowEnabled">‚úì üé¨ Slideshow ({{ exportSlideshowDuration }}s per photo)<br></span>
                            <span v-if="exportMusicFiles.trim()">‚úì üéµ Background Music ({{ exportMusicFiles.split('\n').filter(f => f.trim()).length }} track(s))<br></span>
                            <span v-if="exportSmartTVMode">‚úì üì∫ Smart TV optimized<br></span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div v-if="exportProgress.show" style="background: rgba(74, 222, 128, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid rgba(74, 222, 128, 0.3);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span>{{ exportProgress.message }}</span>
                            <span>{{ exportProgress.current }} / {{ exportProgress.total }}</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #4ade80, #3b82f6); height: 100%; transition: width 0.3s ease;"
                                 :style="{ width: exportProgress.total > 0 ? (exportProgress.current / exportProgress.total * 100) + '%' : '0%' }">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button @click="showNewProjectModal = true; showExportModal = false;" 
                                style="flex: 1; background: rgba(59, 130, 246, 0.2); border: 2px solid rgba(59, 130, 246, 0.5); color: #3b82f6; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;">
                            üíæ Save as Project
                        </button>
                    </div>
                    
                    <button @click="exportGallery" 
                            :disabled="exporting"
                            style="width: 100%; background: linear-gradient(135deg, #4ade80, #3b82f6); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s;">
                        {{ exporting ? 'Exporting...' : 'üì¶ Export Gallery' }}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Add Folder Modal -->
        <div v-if="showAddFolderModal" class="modal" @click.self="showAddFolderModal = false">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">üìÅ Add Media Folder</div>
                    <button class="close-btn" @click="showAddFolderModal = false">√ó</button>
                </div>
                
                <div style="padding: 20px 0;">
                    <p style="color: #888; margin-bottom: 20px;">
                        Add a folder containing photos/videos to this workspace.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Folder Path
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input v-model="newFolderPath"
                                   type="text"
                                   placeholder="C:/Photos/2025"
                                   style="flex: 1; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 0.95rem; font-family: monospace; outline: none;">
                            <button @click="openFolderBrowserForAdd"
                                    style="background: rgba(59, 130, 246, 0.2); border: 2px solid rgba(59, 130, 246, 0.5); color: #3b82f6; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                üìÅ Browse
                            </button>
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 6px;">
                            üí° Use absolute path like: D:/Photos/2025 or C:/Users/Name/Pictures
                        </div>
                    </div>
                    
                    <button @click="addFolder" 
                            :disabled="!newFolderPath.trim()"
                            style="width: 100%; background: linear-gradient(135deg, #4ade80, #3b82f6); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        ‚úì Add Folder
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Config Info Modal -->
        <div v-if="showConfigModal" class="modal-overlay" @click.self="showConfigModal = false">
            <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 style="margin: 0;">üìã Configuration Files</h2>
                    <button @click="showConfigModal = false" style="background: none; border: none; font-size: 1.5rem; color: #888; cursor: pointer;">√ó</button>
                </div>
                
                <div v-if="!configInfo" style="padding: 40px; text-align: center; color: #888;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                    <div>Loading configuration info...</div>
                </div>
                
                <div v-if="configInfo" style="padding: 20px;">
                    <!-- Global Config Root -->
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #4ade80;">üåç Global Configuration</h3>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.9rem; color: #888; margin-bottom: 5px;">
                            {{ configInfo.global_config.root }}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <span :style="{color: configInfo.global_config.exists ? '#4ade80' : '#ef4444'}">
                                {{ configInfo.global_config.exists ? '‚úì Exists' : '‚úó Not Found' }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Media Manager -->
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #3b82f6;">üì± Media Manager</h3>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #888; margin-bottom: 5px;">
                            {{ configInfo.media_manager.config_file }}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span :style="{color: configInfo.media_manager.exists ? '#4ade80' : '#ef4444'}">
                                {{ configInfo.media_manager.exists ? '‚úì Exists' : '‚úó Not Found' }}
                            </span>
                            <span style="color: #888;">Size: {{ configInfo.media_manager.size }}</span>
                            <span style="color: #fbbf24;">{{ configInfo.media_manager.folder_count }} folders</span>
                        </div>
                    </div>
                    
                    <!-- Workspace Registry -->
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #8b5cf6;">üóÇÔ∏è Workspace Registry</h3>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #888; margin-bottom: 5px;">
                            {{ configInfo.workspace_registry.config_file }}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span :style="{color: configInfo.workspace_registry.exists ? '#4ade80' : '#ef4444'}">
                                {{ configInfo.workspace_registry.exists ? '‚úì Exists' : '‚úó Not Found' }}
                            </span>
                            <span style="color: #888;">Size: {{ configInfo.workspace_registry.size }}</span>
                            <span style="color: #fbbf24;">{{ configInfo.workspace_registry.workspace_count }} workspaces</span>
                        </div>
                    </div>
                    
                    <!-- Current Workspace -->
                    <div v-if="configInfo.current_workspace" style="background: rgba(139,92,246,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(139,92,246,0.3);">
                        <h3 style="margin: 0 0 10px 0; color: #8b5cf6;">üìÇ Current Workspace Config</h3>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #888; margin-bottom: 8px;">
                            <strong>Workspace:</strong> {{ configInfo.current_workspace.path }}
                        </div>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #888; margin-bottom: 5px;">
                            <strong>Config:</strong> {{ configInfo.current_workspace.config_file }}
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <span :style="{color: configInfo.current_workspace.exists ? '#4ade80' : '#ef4444'}">
                                {{ configInfo.current_workspace.exists ? '‚úì Exists' : '‚úó Not Found' }}
                            </span>
                            <span style="color: #888;">Size: {{ configInfo.current_workspace.size }}</span>
                        </div>
                    </div>
                    
                    <!-- Sidecar Files -->
                    <div v-if="configInfo.sidecars && configInfo.sidecars.length > 0" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #fbbf24;">üìÑ Sidecar Files (.phototool.json)</h3>
                        <div v-for="sidecar in configInfo.sidecars" :key="sidecar.folder" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #888; margin-bottom: 5px;">
                                {{ sidecar.folder }}
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <span style="color: #fbbf24;">{{ sidecar.sidecar_count }} sidecars</span>
                                <span v-if="sidecar.name" style="color: #888;">{{ sidecar.name }}</span>
                                <span v-if="sidecar.category" :style="{
                                    color: sidecar.category === 'usb' ? '#ec4899' : 
                                           sidecar.category === 'network' ? '#06b6d4' : '#4ade80'
                                }">{{ sidecar.category }}</span>
                                <span v-if="sidecar.enabled !== undefined" :style="{color: sidecar.enabled ? '#4ade80' : '#888'}">
                                    {{ sidecar.enabled ? '‚úì Enabled' : 'Disabled' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Media Folder Modal -->
        <div v-if="showAddMediaFolderModal" class="modal-overlay" @click.self="showAddMediaFolderModal = false">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 style="margin: 0;">‚ûï Add Media Folder</h2>
                    <button @click="showAddMediaFolderModal = false" style="background: none; border: none; font-size: 1.5rem; color: #888; cursor: pointer;">√ó</button>
                </div>
                
                <div class="modal-body">
                    <p style="color: #888; margin-bottom: 20px; font-size: 0.9rem;">
                        Register a media folder for pre-scanning. Scanned folders load instantly in workspaces.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Folder Path *</label>
                        <div style="display: flex; gap: 10px;">
                            <input v-model="newMediaFolderPath" 
                                   type="text" 
                                   placeholder="C:/Photos/2024/" 
                                   style="flex: 1; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                            <button @click="openFileBrowserForMediaFolder"
                                    style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px 16px; border-radius: 6px; cursor: pointer;">
                                üìÅ Browse
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Name (Optional)</label>
                        <input v-model="newMediaFolderName" 
                               type="text" 
                               placeholder="Leave empty to use folder name" 
                               style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Category</label>
                        <select v-model="newMediaFolderCategory"
                                style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
                            <option value="internal" style="background: #1a1a1a;">üíæ Internal Drive (C:, D:)</option>
                            <option value="usb" style="background: #1a1a1a;">üîå USB/External Drive</option>
                            <option value="network" style="background: #1a1a1a;">üåê Network/NAS</option>
                            <option value="cloud" style="background: #1a1a1a;">‚òÅÔ∏è Cloud Storage</option>
                            <option value="other" style="background: #1a1a1a;">üìÇ Other</option>
                        </select>
                        <div style="margin-top: 8px; font-size: 0.8rem; color: #666;">
                            USB drives: Volume serial number will be stored for re-detection after drive letter changes
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #888;">Notes (Optional)</label>
                        <textarea v-model="newMediaFolderNotes" 
                                  placeholder="e.g., 'Lumix S5 DCIM from Trekking Trip 2024'" 
                                  rows="3"
                                  style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; font-size: 0.9rem; resize: vertical;">
                        </textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button @click="showAddMediaFolderModal = false"
                                style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            Cancel
                        </button>
                        <button @click="addMediaFolder"
                                style="background: linear-gradient(135deg, #4ade80, #3b82f6); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                            ‚ûï Add Folder
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Workspace Modal -->
        <div v-if="showAddWorkspaceModal" class="modal" @click.self="showAddWorkspaceModal = false">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">‚ú® New Workspace</div>
                    <button class="close-btn" @click="showAddWorkspaceModal = false">√ó</button>
                </div>
                
                <div style="padding: 20px 0;">
                    <p style="color: #888; margin-bottom: 20px;">
                        Create a new workspace to organize photos by theme, time period, or project.<br>
                        The workspace will be created as a subfolder with the workspace name.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Workspace Name
                        </label>
                        <input v-model="newWorkspaceName"
                               type="text"
                               placeholder="e.g., Vacation 2020-2025"
                               style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem;">
                            Parent Folder
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input v-model="newWorkspacePath"
                                   type="text"
                                   placeholder="C:/PhotoTool"
                                   style="flex: 1; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; font-size: 0.95rem; font-family: monospace; outline: none;">
                            <button @click="openFolderBrowserForWorkspace"
                                    style="background: rgba(59, 130, 246, 0.2); border: 2px solid rgba(59, 130, 246, 0.5); color: #3b82f6; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                üìÅ Browse
                            </button>
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 6px;">
                            üí° Workspace will be created as: <strong>{{ newWorkspacePath }}{{ newWorkspacePath && (newWorkspacePath.endsWith('/') || newWorkspacePath.endsWith('\\')) ? '' : '/' }}{{ newWorkspaceName }}</strong>
                        </div>
                    </div>
                    
                    <button @click="addWorkspace" 
                            :disabled="!newWorkspaceName.trim() || !newWorkspacePath.trim()"
                            style="width: 100%; background: linear-gradient(135deg, #4ade80, #3b82f6); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                        ‚ú® Create Workspace
                    </button>
                </div>
            </div>
        </div>
        
        <!-- File Browser Modal -->
        <div v-if="showFileBrowser" class="modal" @click.self="closeBrowser">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <div class="modal-title">üìÅ Select Folder</div>
                    <button class="close-btn" @click="closeBrowser">√ó</button>
                </div>
                
                <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 20px 0;">
                    <!-- Breadcrumb / Current Path -->
                    <div style="background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 15px; font-family: monospace; font-size: 0.9rem; color: #aaa; overflow-x: auto; white-space: nowrap;">
                        <span v-if="browserIsRoot" style="color: #3b82f6;">üíø Drives</span>
                        <span v-else style="color: #4ade80;">{{ browserCurrentPath || '/' }}</span>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button v-if="browserParentPath !== null && !browserIsRoot" 
                                @click="browseFolders(browserParentPath)"
                                style="flex: 1; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: #fff; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ‚¨ÜÔ∏è Up
                        </button>
                        <button v-if="!browserIsRoot && browserCurrentPath" 
                                @click="selectCurrentBrowserPath"
                                style="flex: 1; background: rgba(74, 222, 128, 0.2); border: 2px solid rgba(74, 222, 128, 0.5); color: #4ade80; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ‚úì Select This Folder
                        </button>
                    </div>
                    
                    <!-- Loading State -->
                    <div v-if="browserLoading" style="flex: 1; display: flex; align-items: center; justify-content: center; color: #888;">
                        <div class="spinner"></div>
                        <span style="margin-left: 15px;">Loading...</span>
                    </div>
                    
                    <!-- Folder List -->
                    <div v-else style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
                        <div v-if="browserFolders.length === 0" style="text-align: center; color: #666; padding: 40px;">
                            üìÇ Empty folder
                        </div>
                        
                        <div v-for="folder in browserFolders" 
                             :key="folder.path"
                             @click="folder.is_accessible ? browseFolders(folder.path) : null"
                             class="browser-folder-item"
                             :class="{ 'not-accessible': !folder.is_accessible }">
                            <div style="font-size: 1.5rem;">
                                {{ browserIsRoot ? 'üíø' : (folder.is_accessible ? 'üìÅ' : 'üîí') }}
                            </div>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 600; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ folder.name }}
                                </div>
                                <div v-if="!browserIsRoot" style="font-size: 0.75rem; color: #666; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ folder.path }}
                                </div>
                            </div>
                            <div v-if="folder.is_accessible" style="color: #3b82f6; font-size: 1.2rem;">
                                ‚ñ∂
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Burst Detail Modal -->
        <div v-if="selectedBurst" class="modal" @click.self="selectedBurst = null">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">
                        {{ selectedBurst.name }} ({{ currentBurstPhotoIndex + 1 }} / {{ selectedBurst.count }})
                    </div>
                    <button class="close-btn" @click="selectedBurst = null">√ó</button>
                </div>
                
                <div class="burst-viewer">
                    <div class="main-photo">
                        <img :src="currentBurstPhoto.thumbnail" 
                             :alt="currentBurstPhoto.name">
                        
                        <div class="photo-info" style="margin-top: 20px;">
                            <div style="font-size: 1.1rem; margin-bottom: 10px;">
                                {{ currentBurstPhoto.name }}
                            </div>
                            
                            <div v-if="currentBurstPhoto.blur_score" style="margin-bottom: 15px;">
                                <span :class="getBlurClass(currentBurstPhoto.blur_score)">
                                    Sharpness: {{ Math.round(currentBurstPhoto.blur_score) }}
                                </span>
                                <span v-if="currentBurstPhoto.is_best" style="margin-left: 10px; color: #4ade80; font-weight: 600;">
                                    ‚≠ê BEST
                                </span>
                            </div>
                            
                            <div class="stars" style="justify-content: center;">
                                <span v-for="n in 5" 
                                      :key="n" 
                                      class="star" 
                                      :class="{ active: n <= currentBurstPhoto.rating }"
                                      @click="rateBurstPhoto(currentBurstPhoto, n)">
                                    ‚òÖ
                                </span>
                            </div>
                        </div>
                        
                        <div class="photo-controls">
                            <button class="nav-btn" 
                                    @click="prevBurstPhoto" 
                                    :disabled="currentBurstPhotoIndex === 0">
                                ‚óÑ Prev
                            </button>
                            <button class="nav-btn" 
                                    @click="nextBurstPhoto" 
                                    :disabled="currentBurstPhotoIndex === selectedBurst.count - 1">
                                Next ‚ñ∫
                            </button>
                        </div>
                    </div>
                    
                    <div class="sidebar">
                        <div v-for="(photo, idx) in selectedBurst.photos" 
                             :key="photo.id"
                             class="sidebar-photo"
                             :class="{ active: idx === currentBurstPhotoIndex }"
                             @click="currentBurstPhotoIndex = idx">
                            <img :src="photo.thumbnail" :alt="photo.name">
                            <div class="sidebar-photo-name">
                                {{ photo.name }}
                                <span v-if="photo.is_best" style="color: #4ade80;">‚≠ê</span>
                            </div>
                            <div v-if="photo.blur_score" 
                                 style="font-size: 0.75rem; color: #888; margin-top: 4px;">
                                Sharp: {{ Math.round(photo.blur_score) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    currentView: 'photos',
                    photos: [],
                    bursts: [],
                    stats: null,
                    loading: true,
                    loadingBursts: false,
                    error: null,
                    burstError: null,
                    totalPhotos: 0,
                    offset: 0,
                    limit: 2500,
                    hoveredPhoto: null,
                    hoverStar: 0,
                    selectedBurst: null,
                    currentBurstPhotoIndex: 0,
                    burstProgress: {
                        show: false,
                        step: '',
                        progress: 0,
                        total: 0,
                        message: ''
                    },
                    burstsFromCache: false,
                    // Blur Detection
                    blurDetectionRunning: false,
                    blurDetectionProgress: null,
                    blurScores: [],
                    blurHistogram: null,
                    blurThresholdValue: 0,
                    blurThresholdEnabled: false,
                    applyingThreshold: false,
                    blurDetectionMethod: 'laplacian',  // Selected method
                    blurMethodInfo: {
                        laplacian: { name: 'Laplacian Variance', range: '0-300', desc: 'Fast, general purpose' },
                        tenengrad: { name: 'Tenengrad (Sobel)', range: '0-50', desc: 'Better for sky/homogeneous areas' },
                        roi: { name: 'ROI-based', range: '0-300', desc: 'Adaptive, focuses on interesting areas' }
                    },
                    // Keywords
                    allKeywords: [],
                    keywordInput: '',
                    showKeywordInput: null,
                    keywordSuggestions: [],
                    // Export
                    showExportModal: false,
                    exportTitle: '',
                    exportTemplate: 'photoswipe',
                    exportSlideshowEnabled: true,      // üÜï Slideshow enabled by default
                    exportSlideshowDuration: 5,        // üÜï 5 seconds per photo
                    exportSmartTVMode: false,          // üÜï Smart TV mode
                    exportMusicFiles: '',              // üÜï Music file paths (newline separated)
                    exporting: false,
                    exportProgress: {
                        show: false,
                        current: 0,
                        total: 0,
                        message: ''
                    },
                    // Projects
                    projects: [],
                    loadingProjects: false,
                    projectError: null,
                    showNewProjectModal: false,
                    newProjectName: '',
                    newProjectMode: 'filter',
                    savingProject: false,
                    currentProject: null,
                    currentProjectId: null,
                    // Quality detection settings
                    qualitySettings: {
                        blur_detection_enabled: true,
                        blur_threshold: 100.0,
                        blur_auto_flag_color: 'red',
                        burst_detection_enabled: true,
                        burst_time_threshold: 3,
                        burst_similarity_threshold: 0.95
                    },
                    blurDetectionStats: null,
                    burstStats: {
                        total: 0,
                        groups: 0
                    },
                    // Workspaces
                    workspaces: [],
                    currentWorkspace: null,
                    workspaceFolders: [],
                    loadingFolders: false,
                    showAddFolderModal: false,
                    showAddWorkspaceModal: false,
                    newFolderPath: '',
                    newWorkspaceName: '',
                    newWorkspacePath: '',
                    // Media Manager
                    mediaFolders: [],
                    loadingMedia: false,
                    mediaError: null,
                    showAddMediaFolderModal: false,
                    newMediaFolderPath: '',
                    newMediaFolderName: '',
                    newMediaFolderCategory: 'internal',
                    newMediaFolderNotes: '',
                    currentScanningFolder: null,
                    scanProgress: null,
                    showConfigModal: false,
                    configInfo: null,
                    // File Browser
                    showFileBrowser: false,
                    browserCurrentPath: '',
                    browserParentPath: null,
                    browserFolders: [],
                    browserIsRoot: false,
                    browserLoading: false,
                    browserCallback: null,
                    // Lightbox
                    showLightbox: false,
                    lightboxPhoto: null,
                    lightboxIndex: 0,
                    // Slideshow
                    showSlideshow: false,
                    slideshowPhotos: [],
                    slideshowIndex: 0,
                    slideshowInterval: null,
                    slideshowPlaying: false,
                    isFullscreen: false,
                    hideControls: false,
                    hideControlsTimeout: null,
                    slideshowSettings: {
                        duration: 5,      // seconds per photo
                        transition: 'fade',
                        loop: true
                    },
                    // Filtering & Sorting
                    filters: {
                        ratings: {
                            0: false,
                            1: false,
                            2: false,
                            3: false,
                            4: false,
                            5: false
                        },
                        colors: {
                            red: false,
                            yellow: false,
                            green: false,
                            blue: false,
                            purple: false,
                            none: false
                        },
                        keywords: [],  // Selected keywords to filter by
                        inBursts: false,
                        blurry: false
                    },
                    sortBy: 'date', // name, date, rating, quality
                    sortOrder: 'desc' // asc, desc (desc = newest first)
                }
            },
            computed: {
                currentBurstPhoto() {
                    if (!this.selectedBurst) return null;
                    return this.selectedBurst.photos[this.currentBurstPhotoIndex];
                },
                
                filteredPhotos() {
                    let filtered = [...this.photos];
                    
                    // Apply rating filters
                    const activeRatings = Object.keys(this.filters.ratings)
                        .filter(r => this.filters.ratings[r])
                        .map(r => parseInt(r));
                    
                    if (activeRatings.length > 0) {
                        filtered = filtered.filter(p => activeRatings.includes(p.rating || 0));
                    }
                    
                    // Apply color filters
                    const activeColors = Object.keys(this.filters.colors)
                        .filter(c => this.filters.colors[c]);
                    
                    if (activeColors.length > 0) {
                        filtered = filtered.filter(p => {
                            const photoColor = p.color || 'none';
                            return activeColors.includes(photoColor);
                        });
                    }
                    
                    // Apply keyword filters
                    if (this.filters.keywords.length > 0) {
                        filtered = filtered.filter(p => {
                            const photoKeywords = p.keywords || [];
                            return this.filters.keywords.some(k => photoKeywords.includes(k));
                        });
                    }
                    
                    if (this.filters.inBursts) {
                        // Check if photo is in any burst
                        const burstPhotoIds = new Set();
                        this.bursts.forEach(burst => {
                            burst.photos.forEach(photo => {
                                burstPhotoIds.add(photo.id);
                            });
                        });
                        filtered = filtered.filter(p => burstPhotoIds.has(p.id));
                    }
                    
                    if (this.filters.blurry) {
                        // This would require blur_score in photo data
                        // For now, skip or implement when available
                    }
                    
                    // Apply sorting
                    filtered.sort((a, b) => {
                        let result = 0;
                        
                        switch (this.sortBy) {
                            case 'name':
                                result = a.name.localeCompare(b.name);
                                break;
                            case 'rating':
                                result = (b.rating || 0) - (a.rating || 0);
                                break;
                            case 'date':
                                // Sort by capture_time (already sorted by backend, but re-sort if needed)
                                if (a.capture_time && b.capture_time) {
                                    result = a.capture_time.localeCompare(b.capture_time);
                                } else if (a.capture_time) {
                                    result = -1;
                                } else if (b.capture_time) {
                                    result = 1;
                                } else {
                                    result = a.name.localeCompare(b.name);
                                }
                                break;
                            case 'quality':
                                // Would need blur_score field
                                result = 0;
                                break;
                        }
                        
                        return this.sortOrder === 'desc' ? -result : result;
                    });
                    
                    return filtered;
                },
                
                activeFilterCount() {
                    let count = 0;
                    count += Object.values(this.filters.ratings).filter(v => v).length;
                    count += Object.values(this.filters.colors).filter(v => v).length;
                    count += this.filters.keywords.length;
                    if (this.filters.inBursts) count++;
                    if (this.filters.blurry) count++;
                    return count;
                },
                
                keywordSuggestionsFiltered() {
                    if (!this.keywordInput) return [];
                    const input = this.keywordInput.toLowerCase();
                    return this.allKeywords
                        .filter(k => k.name.toLowerCase().includes(input))
                        .slice(0, 10);
                },
                
                totalActivePhotos() {
                    return this.workspaceFolders
                        .filter(f => f.enabled)
                        .reduce((sum, f) => sum + (f.photo_count || 0), 0);
                }
            },
            methods: {
                async loadPhotos() {
                    try {
                        this.loading = true;
                        this.error = null;
                        
                        const res = await fetch(`/api/photos?limit=${this.limit}&offset=${this.offset}`);
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Check if there's a message (e.g., no folders enabled)
                        if (data.message && data.total === 0) {
                            this.error = data.message;
                            this.photos = [];
                            this.totalPhotos = 0;
                            return;
                        }
                        
                        this.photos.push(...data.photos);
                        this.totalPhotos = data.total;
                        this.offset += data.photos.length;
                        
                        // Update burst stats
                        this.updateBurstStats();
                        
                    } catch (err) {
                        this.error = err.message;
                        console.error('Error loading photos:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                
                updateBurstStats() {
                    const burstPhotos = this.photos.filter(p => p.burst && p.burst.is_burst);
                    this.burstStats.total = burstPhotos.length;
                    // Group size estimation (approximate)
                    this.burstStats.groups = burstPhotos.length > 0 ? Math.ceil(burstPhotos.length / 3) : 0;
                },
                
                async loadBursts(force = false) {
                    try {
                        this.loadingBursts = true;
                        this.burstError = null;
                        this.burstProgress.show = true;
                        this.burstProgress.message = 'Starting analysis...';
                        
                        // Start progress monitoring if not from cache
                        if (force || this.bursts.length === 0) {
                            this.monitorBurstProgress();
                        }
                        
                        const url = force ? '/api/bursts?force=true' : '/api/bursts';
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.bursts = data.bursts;
                        this.burstsFromCache = data.cached || false;
                        
                        if (data.cached) {
                            console.log('‚úì Loaded from cache:', data.computed_at);
                        }
                        
                    } catch (err) {
                        this.burstError = err.message;
                        console.error('Error loading bursts:', err);
                    } finally {
                        this.loadingBursts = false;
                        this.burstProgress.show = false;
                    }
                },
                
                monitorBurstProgress() {
                    // Use EventSource for Server-Sent Events
                    const eventSource = new EventSource('/api/bursts/progress');
                    
                    eventSource.onmessage = (event) => {
                        const progress = JSON.parse(event.data);
                        
                        this.burstProgress.step = progress.step;
                        this.burstProgress.progress = progress.progress;
                        this.burstProgress.total = progress.total;
                        this.burstProgress.message = progress.message;
                        
                        console.log(`Progress: ${progress.message} (${progress.progress}/${progress.total})`);
                        
                        if (progress.status === 'complete' || progress.status === 'error') {
                            eventSource.close();
                        }
                    };
                    
                    eventSource.onerror = () => {
                        eventSource.close();
                    };
                },
                
                async runBlurDetection() {
                    if (this.blurDetectionRunning) return;
                    
                    try {
                        this.blurDetectionRunning = true;
                        this.blurDetectionProgress = {
                            status: 'running',
                            progress: 0,
                            total: 1,  // Start with 1 to show progress bar
                            message: 'Starting blur detection...',
                            current_file: 'Initializing...'
                        };
                        
                        // Start progress monitoring FIRST
                        this.monitorBlurProgress();
                        
                        // Small delay to ensure EventSource is connected
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Trigger blur detection (calculates and stores scores only)
                        const res = await fetch('/api/quality/detect-blur', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                force: false,  // Don't recalculate if already exists
                                method: this.blurDetectionMethod  // Use selected method
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        console.log(`‚úì Blur scores calculated: ${data.calculated} new, ${data.skipped} skipped`);
                        
                        // Load blur scores and histogram
                        await this.loadBlurScores();
                        
                        // Store statistics
                        this.blurDetectionStats = {
                            total_analyzed: data.total_analyzed,
                            calculated: data.calculated,
                            skipped: data.skipped
                        };
                        
                        // Enable threshold slider
                        this.blurThresholdEnabled = true;
                        
                        // Update progress to complete
                        this.blurDetectionProgress = {
                            status: 'complete',
                            progress: data.total_analyzed,
                            total: data.total_analyzed,
                            message: `Complete! Calculated ${data.calculated}, skipped ${data.skipped}.`,
                            current_file: ''
                        };
                        
                        alert(`‚úì Blur scores calculated (${this.blurDetectionMethod.toUpperCase()})!\n\nNew: ${data.calculated}\nSkipped: ${data.skipped}\n\nNow go to Photos tab and adjust the threshold slider to flag blurry photos.`);
                        
                    } catch (err) {
                        console.error('Error running blur detection:', err);
                        this.blurDetectionProgress = {
                            status: 'error',
                            message: 'Error: ' + err.message,
                            progress: 0,
                            total: 1
                        };
                        alert(`Error: ${err.message}`);
                    } finally {
                        this.blurDetectionRunning = false;
                    }
                },
                
                async loadBlurScores() {
                    try {
                        const res = await fetch(`/api/quality/blur-scores?method=${this.blurDetectionMethod}`);
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.blurScores = data.scores || [];
                        this.blurHistogram = data.histogram || null;
                        
                        console.log(`‚úì Loaded ${this.blurScores.length} blur scores (${this.blurDetectionMethod})`);
                        
                    } catch (err) {
                        console.error('Error loading blur scores:', err);
                    }
                },
                
                async onBlurMethodChange() {
                    // Reload blur scores when method changes
                    await this.loadBlurScores();
                    
                    // Adjust threshold based on method
                    if (this.blurDetectionMethod === 'tenengrad') {
                        // Tenengrad has lower range (0-50)
                        if (this.blurThresholdValue > 50) {
                            this.blurThresholdValue = 25;
                        }
                    }
                    
                    console.log(`‚úì Switched to ${this.blurDetectionMethod} method`);
                },
                
                async applyBlurThreshold() {
                    if (!this.blurThresholdEnabled || this.applyingThreshold) return;
                    
                    try {
                        this.applyingThreshold = true;
                        
                        const res = await fetch('/api/quality/apply-threshold', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                threshold: this.blurThresholdValue,
                                flag_color: this.qualitySettings.blur_auto_flag_color,
                                method: this.blurDetectionMethod
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        console.log(`‚úì Threshold applied: ${data.flagged_count} total flagged, ${data.unflagged_count} unflagged, ${data.changed_count} changed`);
                        
                        // Update blur detection stats for header
                        this.blurDetectionStats = {
                            ...this.blurDetectionStats,
                            flagged_count: data.flagged_count
                        };
                        
                        // Reload photos to show updated flags
                        await this.loadPhotos();
                        
                        alert(`‚úì Threshold ${this.blurThresholdValue} applied (${this.blurDetectionMethod.toUpperCase()})!\n\nTotal flagged (blur < ${this.blurThresholdValue}): ${data.flagged_count}\nUnflagged: ${data.unflagged_count}\nChanged: ${data.changed_count}`);
                        
                    } catch (err) {
                        console.error('Error applying threshold:', err);
                        alert(`Error: ${err.message}`);
                    } finally {
                        this.applyingThreshold = false;
                    }
                },
                
                shouldRangeBeBlurred(range) {
                    // Determine if a histogram range should be flagged based on threshold
                    if (!this.blurThresholdEnabled) return false;
                    
                    const threshold = this.blurThresholdValue;
                    
                    // Parse range (e.g., "0-50", "50-100", "200+")
                    if (range === '200+') {
                        return threshold > 200;
                    }
                    
                    const parts = range.split('-');
                    if (parts.length === 2) {
                        const max = parseInt(parts[1]);
                        return max <= threshold;
                    }
                    
                    return false;
                },
                
                getThresholdMax() {
                    // Return max threshold value based on method
                    if (this.blurDetectionMethod === 'tenengrad') {
                        return 50;  // Tenengrad has lower range
                    }
                    return 300;  // Laplacian and ROI
                },
                
                getThresholdStep() {
                    // Return step size based on method
                    if (this.blurDetectionMethod === 'tenengrad') {
                        return 1;  // Finer control for tenengrad
                    }
                    return 5;  // Coarser for larger ranges
                },
                
                async onProjectChange() {
                    if (!this.currentProjectId) {
                        this.currentProject = null;
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/projects/${this.currentProjectId}`);
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.currentProject = data.project;
                        
                        // Load quality settings
                        if (data.project.quality_settings) {
                            this.qualitySettings = { ...data.project.quality_settings };
                        } else {
                            // Use defaults
                            this.qualitySettings = {
                                blur_detection_enabled: true,
                                blur_threshold: 100.0,
                                blur_auto_flag_color: 'red',
                                burst_detection_enabled: true,
                                burst_time_threshold: 3,
                                burst_similarity_threshold: 0.95
                            };
                        }
                        
                        console.log(`‚úì Loaded project: ${data.project.name}`);
                        
                    } catch (err) {
                        console.error('Error loading project:', err);
                        alert(`Failed to load project: ${err.message}`);
                    }
                },
                
                async saveQualitySettings() {
                    if (!this.currentProjectId) {
                        alert('Please select a project first');
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/projects/${this.currentProjectId}/quality-settings`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                quality_settings: this.qualitySettings
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        alert('‚úì Quality settings saved successfully!');
                        console.log('‚úì Quality settings saved');
                        
                    } catch (err) {
                        console.error('Error saving quality settings:', err);
                        alert(`Failed to save settings: ${err.message}`);
                    }
                },
                
                monitorBlurProgress() {
                    const eventSource = new EventSource('/api/quality/blur-progress');
                    
                    eventSource.onmessage = (event) => {
                        const progress = JSON.parse(event.data);
                        this.blurDetectionProgress = progress;
                        
                        console.log(`Blur detection: ${progress.message} (${progress.progress}/${progress.total})`);
                        
                        if (progress.status === 'complete' || progress.status === 'error') {
                            eventSource.close();
                        }
                    };
                    
                    eventSource.onerror = () => {
                        eventSource.close();
                    };
                },
                
                async loadStats() {
                    try {
                        const res = await fetch('/api/stats');
                        this.stats = await res.json();
                    } catch (err) {
                        console.error('Error loading stats:', err);
                    }
                },
                
                async loadMore() {
                    await this.loadPhotos();
                },
                
                async switchToBursts() {
                    this.currentView = 'bursts';
                    if (this.bursts.length === 0) {
                        await this.loadBursts();
                    }
                },
                
                async switchToProjects() {
                    this.currentView = 'projects';
                    if (this.projects.length === 0) {
                        await this.loadProjects();
                    }
                },
                
                async switchToWorkspaces() {
                    this.currentView = 'workspaces';
                    await this.loadWorkspaces();
                    await this.loadWorkspaceFolders();
                },
                
                async switchToMedia() {
                    this.currentView = 'media';
                    await this.loadMediaFolders();
                },
                
                async loadMediaFolders() {
                    this.loadingMedia = true;
                    this.mediaError = null;
                    
                    try {
                        const res = await fetch('/api/media/folders');
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.mediaFolders = data.folders || [];
                        console.log(`‚úì Loaded ${this.mediaFolders.length} media folders`);
                    } catch (err) {
                        this.mediaError = `Failed to load media folders: ${err.message}`;
                        console.error('Error loading media folders:', err);
                    } finally {
                        this.loadingMedia = false;
                    }
                },
                
                async addMediaFolder() {
                    if (!this.newMediaFolderPath.trim()) {
                        alert('Please enter a folder path');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/media/folders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                path: this.newMediaFolderPath,
                                name: this.newMediaFolderName || null,
                                category: this.newMediaFolderCategory,
                                notes: this.newMediaFolderNotes || null
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Reset form
                        this.newMediaFolderPath = '';
                        this.newMediaFolderName = '';
                        this.newMediaFolderCategory = 'internal';
                        this.newMediaFolderNotes = '';
                        this.showAddMediaFolderModal = false;
                        
                        // Reload
                        await this.loadMediaFolders();
                        
                        alert('‚úì Media folder added successfully!');
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error adding media folder:', err);
                    }
                },
                
                async removeMediaFolder(folderPath) {
                    if (!confirm(`Remove media folder?\n\n${folderPath}\n\nThis will NOT delete any files, only remove from registry.`)) {
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/media/folders/${encodeURIComponent(folderPath)}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        await this.loadMediaFolders();
                        console.log('‚úì Media folder removed');
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error removing media folder:', err);
                    }
                },
                
                async showConfigInfo() {
                    try {
                        this.configInfo = null;
                        this.showConfigModal = true;
                        
                        const response = await fetch('/api/system/config-info');
                        if (!response.ok) {
                            throw new Error('Failed to load config info');
                        }
                        
                        this.configInfo = await response.json();
                    } catch (error) {
                        alert(`Error loading config: ${error.message}`);
                        this.showConfigModal = false;
                    }
                },
                
                async scanMediaFolder(folderPath) {
                    try {
                        this.currentScanningFolder = folderPath;
                        
                        // Initialize progress with proper structure
                        this.scanProgress = {
                            status: 'running',
                            total: 0,
                            completed: 0,
                            current_file: 'Initializing scan...',
                            current_analyzer: '',
                            photos_per_second: 0,
                            estimated_remaining_seconds: 0,
                            elapsed_seconds: 0,
                            error_count: 0
                        };
                        
                        // Start progress monitoring BEFORE triggering scan
                        this.monitorScanProgress(folderPath);
                        
                        // Small delay to let SSE connection establish
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Trigger scan with both blur and burst analyzers
                        const res = await fetch(`/api/media/folders/${encodeURIComponent(folderPath)}/scan`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                analyzers: ['blur', 'burst'],  // Enable both analyzers
                                force: false,
                                threads: 4
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        console.log('‚úì Scan started for', folderPath);
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error starting scan:', err);
                        this.currentScanningFolder = null;
                        this.scanProgress = null;
                    }
                },
                
                monitorScanProgress(folderPath) {
                    const eventSource = new EventSource(`/api/media/folders/${encodeURIComponent(folderPath)}/scan-progress`);
                    
                    eventSource.onmessage = (event) => {
                        const progress = JSON.parse(event.data);
                        this.scanProgress = progress;
                        
                        console.log(`Scan: ${progress.current_file} (${progress.completed}/${progress.total})`);
                        
                        if (progress.status === 'complete') {
                            eventSource.close();
                            this.currentScanningFolder = null;
                            this.loadMediaFolders();  // Reload to show updated status
                            alert(`‚úì Scan complete!\n\nAnalyzed ${progress.completed} photos`);
                        } else if (progress.status === 'error') {
                            eventSource.close();
                            this.currentScanningFolder = null;
                            alert(`Error during scan: ${progress.message}`);
                        }
                    };
                    
                    eventSource.onerror = () => {
                        eventSource.close();
                        this.currentScanningFolder = null;
                    };
                },
                
                isFolderAvailable(folder) {
                    // Check if folder path exists (will be checked server-side)
                    // For now, just check offline flag
                    return folder.path && folder.path.length > 0;
                },
                
                isScanningFolder(folderPath) {
                    return this.currentScanningFolder === folderPath;
                },
                
                getCategoryColor(category) {
                    const colors = {
                        internal: 'rgba(74, 222, 128, 0.2)',
                        usb: 'rgba(251, 191, 36, 0.2)',
                        network: 'rgba(59, 130, 246, 0.2)',
                        cloud: 'rgba(168, 85, 247, 0.2)',
                        other: 'rgba(156, 163, 175, 0.2)'
                    };
                    return colors[category] || colors.other;
                },
                
                getCategoryIcon(category) {
                    const icons = {
                        internal: 'üíæ',
                        usb: 'üîå',
                        network: 'üåê',
                        cloud: '‚òÅÔ∏è',
                        other: 'üìÇ'
                    };
                    return icons[category] || icons.other;
                },
                
                formatDate(isoString) {
                    if (!isoString) return 'N/A';
                    const date = new Date(isoString);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },
                
                async resetAllRatings() {
                    if (!confirm(`Reset ALL star ratings for ${this.filteredPhotos.length} visible photos?\n\nThis cannot be undone!`)) {
                        return;
                    }
                    
                    try {
                        let updated = 0;
                        for (const photo of this.filteredPhotos) {
                            if (photo.rating > 0) {
                                await fetch(`/api/photos/${encodeURIComponent(photo.id)}/rating`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ rating: 0 })
                                });
                                photo.rating = 0;
                                updated++;
                            }
                        }
                        
                        await this.loadStats();
                        alert(`‚úì Reset ${updated} star ratings`);
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error resetting ratings:', err);
                    }
                },
                
                async resetAllColors() {
                    if (!confirm(`Reset ALL color labels for ${this.filteredPhotos.length} visible photos?\n\nThis cannot be undone!`)) {
                        return;
                    }
                    
                    try {
                        let updated = 0;
                        for (const photo of this.filteredPhotos) {
                            if (photo.color) {
                                await this.setColor(photo, null);
                                updated++;
                            }
                        }
                        
                        alert(`‚úì Reset ${updated} color labels`);
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error resetting colors:', err);
                    }
                },
                
                async loadWorkspaces() {
                    try {
                        const res = await fetch('/api/workspaces');
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.workspaces = data.workspaces || [];
                        this.currentWorkspace = data.current;
                    } catch (err) {
                        console.error('Error loading workspaces:', err);
                    }
                },
                
                async loadWorkspaceFolders() {
                    this.loadingFolders = true;
                    
                    try {
                        const res = await fetch('/api/workspace/folders');
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.workspaceFolders = data.folders || [];
                    } catch (err) {
                        console.error('Error loading folders:', err);
                    } finally {
                        this.loadingFolders = false;
                    }
                },
                
                async toggleFolder(folderPath, enabled) {
                    try {
                        const res = await fetch('/api/workspace/folders/toggle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                path: folderPath,
                                enabled: enabled
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Update local state
                        const folder = this.workspaceFolders.find(f => f.path === folderPath);
                        if (folder) {
                            folder.enabled = enabled;
                        }
                        
                        // Always reset photo list so it reloads when user switches to photos tab
                        this.photos = [];
                        this.offset = 0;
                        
                        // Reload stats to update total count
                        await this.loadStats();
                        
                        // If currently on photos tab, reload immediately
                        if (this.currentView === 'photos') {
                            await this.loadPhotos();
                        }
                        
                    } catch (err) {
                        alert(`Failed to toggle folder: ${err.message}`);
                        console.error('Error toggling folder:', err);
                    }
                },
                
                async addFolder() {
                    if (!this.newFolderPath.trim()) {
                        alert('Please enter a folder path');
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/workspace/folders/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                path: this.newFolderPath
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.newFolderPath = '';
                        this.showAddFolderModal = false;
                        
                        // Reload folders
                        await this.loadWorkspaceFolders();
                        
                        // Reload stats to update total count
                        await this.loadStats();
                        
                        // Switch to photos view and load photos
                        this.currentView = 'photos';
                        this.photos = [];
                        this.offset = 0;
                        await this.loadPhotos();
                        
                        alert('‚úì Folder added and enabled! Loading photos...');
                        
                    } catch (err) {
                        alert(`Failed to add folder: ${err.message}`);
                        console.error('Error adding folder:', err);
                    }
                },
                
                async removeFolder(folderPath) {
                    if (!confirm(`Remove folder from workspace?\n\n${folderPath}\n\nThis will NOT delete any files, only remove from workspace configuration.`)) {
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/workspace/folders/remove', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: folderPath })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Reload folders
                        await this.loadWorkspaceFolders();
                        
                        // Reset photo list
                        this.photos = [];
                        this.offset = 0;
                        
                        console.log('‚úì Folder removed from workspace');
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error removing folder:', err);
                    }
                },
                
                confirmDeleteWorkspace(workspace) {
                    if (workspace.path === this.currentWorkspace) {
                        alert('Cannot delete the currently active workspace.\nPlease switch to another workspace first.');
                        return;
                    }
                    
                    const workspaceName = workspace.name || workspace.path;
                    
                    // First confirmation: Remove from registry?
                    if (!confirm(
                        `Remove Workspace "${workspaceName}"?\n\n` +
                        `Path: ${workspace.path}\n\n` +
                        `This will remove the workspace from the registry.\n` +
                        `Media files will NOT be deleted.\n\n` +
                        `Continue?`
                    )) {
                        return;
                    }
                    
                    // Second confirmation: Delete config.yaml?
                    const deleteConfig = confirm(
                        `Delete config.yaml file?\n\n` +
                        `File: ${workspace.path}/config.yaml\n\n` +
                        `This will permanently delete the workspace configuration.\n` +
                        `Media files will remain untouched.\n\n` +
                        `YES = Delete config.yaml\n` +
                        `NO = Keep config.yaml (only remove from registry)`
                    );
                    
                    this.deleteWorkspace(workspace.path, deleteConfig);
                },
                
                async deleteWorkspace(path, deleteConfig = false) {
                    try {
                        const res = await fetch(`/api/workspaces/${encodeURIComponent(path)}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ delete_config: deleteConfig })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Reload workspaces
                        await this.loadWorkspaces();
                        
                        const msg = deleteConfig 
                            ? `‚úì Workspace removed and config.yaml deleted`
                            : `‚úì Workspace removed from registry (config.yaml kept)`;
                        
                        alert(msg);
                    } catch (err) {
                        alert(`Error: ${err.message}`);
                        console.error('Error deleting workspace:', err);
                    }
                },
                
                async switchToWorkspace(path) {
                    try {
                        const res = await fetch('/api/workspaces/switch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: path })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.currentWorkspace = path;
                        
                        // Reload everything
                        await this.loadWorkspaceFolders();
                        await this.loadProjects();
                        await this.loadStats();
                        
                        // Switch to photos view
                        this.currentView = 'photos';
                        this.photos = [];
                        this.offset = 0;
                        await this.loadPhotos();
                        
                        alert(`‚úì Switched to workspace`);
                        
                    } catch (err) {
                        alert(`Failed to switch workspace: ${err.message}`);
                        console.error('Error switching workspace:', err);
                    }
                },
                
                async addWorkspace() {
                    if (!this.newWorkspaceName.trim() || !this.newWorkspacePath.trim()) {
                        alert('Please enter workspace name and path');
                        return;
                    }
                    
                    try {
                        // Create workspace path: parent_path/workspace_name
                        const parentPath = this.newWorkspacePath;
                        const workspaceName = this.newWorkspaceName.trim();
                        const fullWorkspacePath = parentPath.endsWith('/') || parentPath.endsWith('\\') 
                            ? parentPath + workspaceName 
                            : parentPath + '/' + workspaceName;
                        
                        const res = await fetch('/api/workspaces', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                path: fullWorkspacePath,
                                name: workspaceName
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        const newWorkspacePath = fullWorkspacePath;
                        
                        this.newWorkspaceName = '';
                        this.newWorkspacePath = '';
                        this.showAddWorkspaceModal = false;
                        
                        // Reload workspaces
                        await this.loadWorkspaces();
                        
                        // Switch to the new workspace
                        await this.switchToWorkspace(newWorkspacePath);
                        
                        alert('‚úì Workspace created and activated!');
                    
                    } catch (err) {
                        alert(`Failed to add workspace: ${err.message}`);
                        console.error('Error adding workspace:', err);
                    }
                },
                
                // ===== FILE BROWSER =====
                
                openFileBrowser(callback) {
                    this.browserCallback = callback;
                    this.browserCurrentPath = '';
                    this.browserFolders = [];
                    this.browserIsRoot = false;
                    this.showFileBrowser = true;
                    this.browseFolders('');
                },
                
                async browseFolders(path) {
                    this.browserLoading = true;
                    try {
                        const res = await fetch(`/api/browse/folders?path=${encodeURIComponent(path || '')}`);
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.browserCurrentPath = data.current_path;
                        this.browserParentPath = data.parent;
                        this.browserFolders = data.folders || [];
                        this.browserIsRoot = data.is_root || false;
                        
                    } catch (err) {
                        alert(`Failed to browse: ${err.message}`);
                        console.error('Browse error:', err);
                    } finally {
                        this.browserLoading = false;
                    }
                },
                
                selectBrowserFolder(folderPath) {
                    if (this.browserCallback) {
                        this.browserCallback(folderPath);
                    }
                    this.closeBrowser();
                },
                
                selectCurrentBrowserPath() {
                    if (this.browserCurrentPath && this.browserCallback) {
                        this.browserCallback(this.browserCurrentPath);
                    }
                    this.closeBrowser();
                },
                
                closeBrowser() {
                    this.showFileBrowser = false;
                    this.browserCallback = null;
                },
                
                openFolderBrowserForAdd() {
                    this.openFileBrowser((path) => {
                        this.newFolderPath = path;
                    });
                },
                
                openFolderBrowserForWorkspace() {
                    this.openFileBrowser((path) => {
                        this.newWorkspacePath = path;
                    });
                },
                
                openFileBrowserForMediaFolder() {
                    this.openFileBrowser((path) => {
                        this.newMediaFolderPath = path;
                    });
                },
                
                // ===== END FILE BROWSER =====
                
                async switchToPhotosView() {
                    this.currentView = 'photos';
                    
                    // If photos list is empty (e.g., after toggling folders), reload
                    if (this.photos.length === 0) {
                        await Promise.all([
                            this.loadPhotos(),
                            this.loadStats()
                        ]);
                    }
                },
                
                async switchWorkspace() {
                    // Called when dropdown changes
                    if (this.currentWorkspace) {
                        await this.switchToWorkspace(this.currentWorkspace);
                    }
                },
                
                async loadProjects() {
                    this.loadingProjects = true;
                    this.projectError = null;
                    
                    try {
                        const res = await fetch('/api/projects');
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        this.projects = data.projects || [];
                    } catch (err) {
                        this.projectError = `Failed to load projects: ${err.message}`;
                        console.error('Error loading projects:', err);
                    } finally {
                        this.loadingProjects = false;
                    }
                },
                
                async saveNewProject() {
                    if (!this.newProjectName.trim()) {
                        alert('Please enter a project name');
                        return;
                    }
                    
                    this.savingProject = true;
                    
                    try {
                        // Collect current filters
                        const filters = {
                            ratings: Object.keys(this.filters.ratings).filter(r => this.filters.ratings[r]).map(Number),
                            colors: this.filters.colors.length > 0 ? this.filters.colors : null,
                            keywords: this.filters.keywords.length > 0 ? this.filters.keywords : null,
                            in_bursts: this.filters.inBursts || null
                        };
                        
                        // Get photo IDs if explicit mode
                        const photoIds = this.newProjectMode === 'explicit' ? 
                            this.filteredPhotos.map(p => p.id) : null;
                        
                        // Collect export settings
                        const exportSettings = {
                            slideshow_enabled: this.exportSlideshowEnabled,
                            slideshow_duration: this.exportSlideshowDuration,
                            smart_tv_mode: this.exportSmartTVMode,
                            template: this.exportTemplate,
                            music_files: this.exportMusicFiles.split('\n').map(f => f.trim()).filter(f => f)
                        };
                        
                        const res = await fetch('/api/projects', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.newProjectName,
                                selection_mode: this.newProjectMode,
                                filters: this.newProjectMode !== 'explicit' ? filters : null,
                                photo_ids: photoIds,
                                export_settings: exportSettings
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Reset form
                        this.newProjectName = '';
                        this.newProjectMode = 'filter';
                        this.showNewProjectModal = false;
                        
                        // Reload projects
                        await this.loadProjects();
                        
                        alert(`‚úì Project "${data.project.name}" saved successfully!`);
                        
                    } catch (err) {
                        alert(`Failed to save project: ${err.message}`);
                        console.error('Error saving project:', err);
                    } finally {
                        this.savingProject = false;
                    }
                },
                
                async loadProject(projectId) {
                    try {
                        const res = await fetch(`/api/projects/${projectId}`);
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        const project = data.project;
                        this.currentProject = project;
                        
                        // Restore filters
                        if (project.filters) {
                            // Reset filters first
                            Object.keys(this.filters.ratings).forEach(r => {
                                this.filters.ratings[r] = false;
                            });
                            this.filters.colors = [];
                            this.filters.keywords = [];
                            this.filters.inBursts = false;
                            
                            // Apply project filters
                            if (project.filters.ratings) {
                                project.filters.ratings.forEach(r => {
                                    this.filters.ratings[r] = true;
                                });
                            }
                            if (project.filters.colors) {
                                this.filters.colors = project.filters.colors;
                            }
                            if (project.filters.keywords) {
                                this.filters.keywords = project.filters.keywords;
                            }
                            if (project.filters.in_bursts) {
                                this.filters.inBursts = true;
                            }
                        }
                        
                        // Restore export settings
                        if (project.export_settings) {
                            this.exportSlideshowEnabled = project.export_settings.slideshow_enabled ?? true;
                            this.exportSlideshowDuration = project.export_settings.slideshow_duration ?? 5;
                            this.exportSmartTVMode = project.export_settings.smart_tv_mode ?? false;
                            this.exportTemplate = project.export_settings.template ?? 'photoswipe';
                            this.exportMusicFiles = project.export_settings.music_files ? 
                                project.export_settings.music_files.join('\n') : '';
                        }
                        
                        // Switch to photos view
                        this.currentView = 'photos';
                        
                        // Reload photos to apply filters
                        this.photos = [];
                        this.offset = 0;
                        await this.loadPhotos();
                        
                        alert(`‚úì Project "${project.name}" loaded!\n\n${this.filteredPhotos.length} photos selected`);
                        
                    } catch (err) {
                        alert(`Failed to load project: ${err.message}`);
                        console.error('Error loading project:', err);
                    }
                },
                
                async exportProject(projectId) {
                    try {
                        // Load project first
                        await this.loadProject(projectId);
                        
                        // Open export modal
                        this.openExportModal();
                        
                    } catch (err) {
                        alert(`Failed to export project: ${err.message}`);
                        console.error('Error exporting project:', err);
                    }
                },
                
                async editProject(projectId) {
                    alert('Edit project - coming soon!');
                    // TODO: Implement edit functionality
                },
                
                async confirmDeleteProject(projectId) {
                    const project = this.projects.find(p => p.id === projectId);
                    if (!project) return;
                    
                    if (!confirm(`Delete project "${project.name}"?\n\nThis cannot be undone.`)) {
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/projects/${projectId}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Reload projects
                        await this.loadProjects();
                        
                        alert(`‚úì Project "${project.name}" deleted`);
                        
                    } catch (err) {
                        alert(`Failed to delete project: ${err.message}`);
                        console.error('Error deleting project:', err);
                    }
                },
                
                formatDate(isoString) {
                    if (!isoString) return '';
                    const date = new Date(isoString);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },
                
                formatCaptureTime(timestamp) {
                    if (!timestamp) return '';
                    // Parse "YYYY-MM-DD HH:MM:SS" format
                    const parts = timestamp.split(' ');
                    if (parts.length === 2) {
                        const dateParts = parts[0].split('-');
                        const timeParts = parts[1].split(':');
                        return `${dateParts[2]}.${dateParts[1]}.${dateParts[0]} ${timeParts[0]}:${timeParts[1]}`;
                    }
                    return timestamp;
                },
                
                async rate(photo, rating) {
                    const oldRating = photo.rating;
                    photo.rating = rating;
                    
                    try {
                        const res = await fetch(`/api/photos/${encodeURIComponent(photo.id)}/rate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ rating })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Update stats
                        if (oldRating === 0 && rating > 0) {
                            this.stats.rated_photos++;
                            this.stats.unrated_photos--;
                        } else if (oldRating > 0 && rating === 0) {
                            this.stats.rated_photos--;
                            this.stats.unrated_photos++;
                        }
                        
                    } catch (err) {
                        photo.rating = oldRating;
                        this.error = `Failed to rate photo: ${err.message}`;
                        console.error('Error rating photo:', err);
                    }
                },
                
                async rateBurstPhoto(photo, stars) {
                    await this.rate(photo, stars);
                },
                
                openBurstViewer(burst) {
                    this.selectedBurst = burst;
                    this.currentBurstPhotoIndex = 0;
                },
                
                nextBurstPhoto() {
                    if (this.currentBurstPhotoIndex < this.selectedBurst.count - 1) {
                        this.currentBurstPhotoIndex++;
                    }
                },
                
                prevBurstPhoto() {
                    if (this.currentBurstPhotoIndex > 0) {
                        this.currentBurstPhotoIndex--;
                    }
                },
                
                getBlurClass(score) {
                    if (!score) return '';
                    if (score >= 150) return 'good';
                    if (score >= 100) return 'warning';
                    return 'bad';
                },
                
                clearFilters() {
                    this.filters = {
                        ratings: {
                            0: false,
                            1: false,
                            2: false,
                            3: false,
                            4: false,
                            5: false
                        },
                        colors: {
                            red: false,
                            yellow: false,
                            green: false,
                            blue: false,
                            purple: false,
                            none: false
                        },
                        keywords: [],
                        inBursts: false,
                        blurry: false
                    };
                },
                
                async setColor(photo, color) {
                    const oldColor = photo.color;
                    photo.color = color;
                    
                    try {
                        const res = await fetch(`/api/photos/${encodeURIComponent(photo.id)}/color`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ color })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        console.log(`‚úì Set color ${color} for ${photo.name}`);
                        
                    } catch (err) {
                        photo.color = oldColor;
                        this.error = `Failed to set color: ${err.message}`;
                        console.error('Error setting color:', err);
                    }
                },
                
                handleImageError(event, photo) {
                    console.warn(`Failed to load thumbnail for ${photo.name}`);
                    event.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23333" width="100" height="100"/><text x="50" y="50" text-anchor="middle" dy=".3em" fill="%23666" font-size="40">üì∑</text></svg>';
                },
                
                getColorHex(color) {
                    const colors = {
                        red: '#ef4444',
                        yellow: '#fbbf24',
                        green: '#4ade80',
                        blue: '#3b82f6',
                        purple: '#a855f7'
                    };
                    return colors[color] || '#888';
                },
                
                getPhotoBlurScore(photo) {
                    // Get blur score for currently selected method
                    if (!photo.blur_scores) return null;
                    return photo.blur_scores[this.blurDetectionMethod];
                },
                
                getBlurScoreTooltip(photo) {
                    if (!photo.blur_scores) return '';
                    
                    const currentScore = photo.blur_scores[this.blurDetectionMethod];
                    const tooltip = [`${this.blurDetectionMethod.toUpperCase()}: ${currentScore ? Math.round(currentScore) : 'N/A'} - ${this.getBlurScoreLabel(currentScore || 0)}`];
                    
                    // Show all available scores
                    if (photo.blur_scores.laplacian && this.blurDetectionMethod !== 'laplacian') {
                        tooltip.push(`LAP: ${Math.round(photo.blur_scores.laplacian)}`);
                    }
                    if (photo.blur_scores.tenengrad && this.blurDetectionMethod !== 'tenengrad') {
                        tooltip.push(`TEN: ${Math.round(photo.blur_scores.tenengrad)}`);
                    }
                    if (photo.blur_scores.roi && this.blurDetectionMethod !== 'roi') {
                        tooltip.push(`ROI: ${Math.round(photo.blur_scores.roi)}`);
                    }
                    
                    return tooltip.join(' | ');
                },
                
                getBlurScoreColor(score) {
                    // Return color based on blur score
                    if (score < 50) return '#ef4444';      // Red - Very Blurry
                    if (score < 100) return '#fb923c';     // Orange - Blurry
                    if (score < 150) return '#fbbf24';     // Yellow - Acceptable
                    if (score < 200) return '#4ade80';     // Green - Sharp
                    return '#22c55e';                       // Bright Green - Very Sharp
                },
                
                getBlurScoreLabel(score) {
                    // Return label based on blur score
                    if (score < 50) return 'Very Blurry';
                    if (score < 100) return 'Blurry';
                    if (score < 150) return 'Acceptable';
                    if (score < 200) return 'Sharp';
                    return 'Very Sharp';
                },
                
                async loadKeywords() {
                    try {
                        const res = await fetch('/api/keywords');
                        const data = await res.json();
                        this.allKeywords = data.keywords || [];
                    } catch (err) {
                        console.error('Error loading keywords:', err);
                    }
                },
                
                async addKeyword(photo, keyword) {
                    if (!keyword || !keyword.trim()) return;
                    
                    keyword = keyword.trim().toLowerCase();
                    
                    if (photo.keywords && photo.keywords.includes(keyword)) {
                        return;
                    }
                    
                    try {
                        const res = await fetch(`/api/photos/${encodeURIComponent(photo.id)}/keywords`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ add: keyword })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        photo.keywords = data.keywords;
                        this.keywordInput = '';
                        this.showKeywordInput = null;
                        
                        await this.loadKeywords();
                        
                    } catch (err) {
                        this.error = `Failed to add keyword: ${err.message}`;
                        console.error('Error adding keyword:', err);
                    }
                },
                
                async removeKeyword(photo, keyword) {
                    try {
                        const res = await fetch(`/api/photos/${encodeURIComponent(photo.id)}/keywords`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ remove: keyword })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        photo.keywords = data.keywords;
                        
                        await this.loadKeywords();
                        
                    } catch (err) {
                        this.error = `Failed to remove keyword: ${err.message}`;
                        console.error('Error removing keyword:', err);
                    }
                },
                
                toggleKeywordFilter(keyword) {
                    const index = this.filters.keywords.indexOf(keyword);
                    if (index > -1) {
                        this.filters.keywords.splice(index, 1);
                    } else {
                        this.filters.keywords.push(keyword);
                    }
                },
                
                openExportModal() {
                    if (this.filteredPhotos.length === 0) {
                        alert('No photos to export! Apply some filters first.');
                        return;
                    }
                    
                    this.showExportModal = true;
                    this.exportTitle = `Photo Gallery - ${new Date().toISOString().split('T')[0]}`;
                },
                
                async exportGallery() {
                    if (!this.exportTitle.trim()) {
                        alert('Please enter a gallery title');
                        return;
                    }
                    
                    this.exporting = true;
                    this.exportProgress.show = true;
                    this.exportProgress.total = this.filteredPhotos.length;
                    this.exportProgress.current = 0;
                    
                    // Monitor progress
                    this.monitorExportProgress();
                    
                    try {
                        const photoIds = this.filteredPhotos.map(p => p.id);
                        const outputName = this.exportTitle
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/^-|-$/g, '');
                        
                        // Parse music files (newline separated)
                        const musicFiles = this.exportMusicFiles
                            .split('\n')
                            .map(f => f.trim())
                            .filter(f => f.length > 0);
                        
                        const res = await fetch('/api/export/gallery', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                photo_ids: photoIds,
                                title: this.exportTitle,
                                output_name: outputName,
                                template: this.exportTemplate,
                                // üÜï NEW PARAMETERS
                                slideshow_enabled: this.exportSlideshowEnabled,
                                slideshow_duration: this.exportSlideshowDuration,
                                smart_tv_mode: this.exportSmartTVMode,
                                music_files: musicFiles.length > 0 ? musicFiles : undefined
                            })
                        });
                        
                        const data = await res.json();
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        let message = `‚úì Gallery exported successfully!\n\n`;
                        message += `Photos: ${data.photo_count}\n`;
                        if (data.music_count > 0) {
                            message += `üéµ Music tracks: ${data.music_count}\n`;
                        }
                        if (this.exportSlideshowEnabled) {
                            message += `üé¨ Slideshow: ${this.exportSlideshowDuration}s per photo\n`;
                        }
                        message += `\nLocation: ${data.gallery_path}\n\nOpen: ${data.index_html}`;
                        
                        alert(message);
                        
                        this.showExportModal = false;
                        
                    } catch (err) {
                        alert(`Failed to export gallery: ${err.message}`);
                        console.error('Export error:', err);
                    } finally {
                        this.exporting = false;
                        this.exportProgress.show = false;
                    }
                },
                
                monitorExportProgress() {
                    const eventSource = new EventSource('/api/export/progress');
                    
                    eventSource.onmessage = (event) => {
                        const progress = JSON.parse(event.data);
                        
                        this.exportProgress.current = progress.current;
                        this.exportProgress.total = progress.total;
                        this.exportProgress.message = progress.message;
                        
                        console.log(`Export: ${progress.message} (${progress.current}/${progress.total})`);
                        
                        if (progress.status === 'complete' || progress.status === 'error') {
                            eventSource.close();
                        }
                    };
                    
                    eventSource.onerror = () => {
                        eventSource.close();
                    };
                },
                
                openLightbox(photo, index) {
                    this.lightboxPhoto = photo;
                    this.lightboxIndex = index;
                    this.showLightbox = true;
                    document.addEventListener('keydown', this.handleLightboxKeyboard);
                },
                
                closeLightbox() {
                    this.showLightbox = false;
                    this.lightboxPhoto = null;
                    document.removeEventListener('keydown', this.handleLightboxKeyboard);
                },
                
                nextPhoto() {
                    if (this.lightboxIndex < this.filteredPhotos.length - 1) {
                        this.lightboxIndex++;
                        this.lightboxPhoto = this.filteredPhotos[this.lightboxIndex];
                    }
                },
                
                prevPhoto() {
                    if (this.lightboxIndex > 0) {
                        this.lightboxIndex--;
                        this.lightboxPhoto = this.filteredPhotos[this.lightboxIndex];
                    }
                },
                
                async rateLightboxPhoto(rating) {
                    await this.rate(this.lightboxPhoto, rating);
                },
                
                handleLightboxKeyboard(e) {
                    if (!this.showLightbox) return;
                    
                    switch(e.key) {
                        case 'Escape':
                            this.closeLightbox();
                            break;
                        case 'ArrowLeft':
                            this.prevPhoto();
                            break;
                        case 'ArrowRight':
                            this.nextPhoto();
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                            this.rateLightboxPhoto(parseInt(e.key));
                            break;
                        case 'c':
                        case 'C':
                            // Cycle through colors
                            const colors = ['red', 'yellow', 'green', 'blue', 'purple', null];
                            const currentIndex = colors.indexOf(this.lightboxPhoto.color);
                            const nextColor = colors[(currentIndex + 1) % colors.length];
                            this.setColor(this.lightboxPhoto, nextColor);
                            break;
                        case '0':
                            // Clear rating
                            this.rateLightboxPhoto(0);
                            break;
                    }
                },
                
                // ========================================
                // SLIDESHOW METHODS
                // ========================================
                
                startSlideshow() {
                    if (this.filteredPhotos.length === 0) {
                        alert('No photos to show in slideshow!');
                        return;
                    }
                    
                    this.slideshowPhotos = [...this.filteredPhotos];
                    this.slideshowIndex = 0;
                    this.showSlideshow = true;
                    this.slideshowPlaying = false;
                    this.hideControls = false;
                    
                    // Auto-start playback
                    this.$nextTick(() => {
                        this.playSlideshowAuto();
                        
                        // Add fullscreen change listener
                        document.addEventListener('fullscreenchange', this.handleFullscreenChange);
                        
                        // Start auto-hide timer
                        this.startHideControlsTimer();
                    });
                    
                    // Add keyboard listener
                    document.addEventListener('keydown', this.handleSlideshowKeyboard);
                },
                
                exitSlideshow() {
                    // Exit fullscreen if active
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    
                    this.stopSlideshow();
                    this.stopHideControlsTimer();
                    
                    this.showSlideshow = false;
                    this.slideshowPhotos = [];
                    this.isFullscreen = false;
                    this.hideControls = false;
                    
                    document.removeEventListener('keydown', this.handleSlideshowKeyboard);
                    document.removeEventListener('fullscreenchange', this.handleFullscreenChange);
                },
                
                playSlideshowAuto() {
                    if (this.slideshowInterval) {
                        clearInterval(this.slideshowInterval);
                    }
                    
                    this.slideshowPlaying = true;
                    this.slideshowInterval = setInterval(() => {
                        this.nextSlide();
                    }, this.slideshowSettings.duration * 1000);
                },
                
                stopSlideshow() {
                    if (this.slideshowInterval) {
                        clearInterval(this.slideshowInterval);
                        this.slideshowInterval = null;
                    }
                    this.slideshowPlaying = false;
                },
                
                toggleSlideshowPlay() {
                    if (this.slideshowPlaying) {
                        this.stopSlideshow();
                    } else {
                        this.playSlideshowAuto();
                    }
                },
                
                nextSlide() {
                    if (this.slideshowIndex < this.slideshowPhotos.length - 1) {
                        this.slideshowIndex++;
                    } else if (this.slideshowSettings.loop) {
                        // Loop back to beginning
                        this.slideshowIndex = 0;
                    } else {
                        // End of slideshow, stop
                        this.stopSlideshow();
                    }
                },
                
                prevSlide() {
                    if (this.slideshowIndex > 0) {
                        this.slideshowIndex--;
                    } else if (this.slideshowSettings.loop) {
                        // Loop to end
                        this.slideshowIndex = this.slideshowPhotos.length - 1;
                    }
                },
                
                restartSlideshowIfPlaying() {
                    if (this.slideshowPlaying) {
                        this.stopSlideshow();
                        this.playSlideshowAuto();
                    }
                },
                
                toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        // Enter fullscreen
                        const slideshowElement = document.querySelector('.slideshow');
                        if (slideshowElement) {
                            slideshowElement.requestFullscreen().catch(err => {
                                console.error('Error entering fullscreen:', err);
                                alert('Fullscreen not supported or denied');
                            });
                        }
                    } else {
                        // Exit fullscreen
                        document.exitFullscreen().catch(err => {
                            console.error('Error exiting fullscreen:', err);
                        });
                    }
                },
                
                handleFullscreenChange() {
                    this.isFullscreen = !!document.fullscreenElement;
                    
                    // If fullscreen was exited externally (ESC key), update state
                    if (!this.isFullscreen && !this.showSlideshow) {
                        // Slideshow was already closed
                        document.removeEventListener('fullscreenchange', this.handleFullscreenChange);
                    }
                },
                
                // ========================================
                // AUTO-HIDE CONTROLS (YouTube-style)
                // ========================================
                
                startHideControlsTimer() {
                    // Clear any existing timer
                    this.stopHideControlsTimer();
                    
                    // Show controls initially
                    this.hideControls = false;
                    
                    // Hide after 3 seconds of inactivity
                    this.hideControlsTimeout = setTimeout(() => {
                        this.hideControls = true;
                    }, 3000);
                },
                
                stopHideControlsTimer() {
                    if (this.hideControlsTimeout) {
                        clearTimeout(this.hideControlsTimeout);
                        this.hideControlsTimeout = null;
                    }
                },
                
                showControlsTemporarily() {
                    // Show controls
                    this.hideControls = false;
                    
                    // Restart hide timer
                    this.startHideControlsTimer();
                },
                
                handleSlideshowKeyboard(e) {
                    if (!this.showSlideshow) return;
                    
                    // Show controls on any keyboard input
                    this.showControlsTemporarily();
                    
                    switch(e.key) {
                        case 'Escape':
                            // ESC exits fullscreen first, then slideshow
                            if (document.fullscreenElement) {
                                document.exitFullscreen();
                            } else {
                                this.exitSlideshow();
                            }
                            break;
                        case ' ':
                        case 'Space':
                            e.preventDefault();
                            this.toggleSlideshowPlay();
                            break;
                        case 'ArrowLeft':
                            this.prevSlide();
                            break;
                        case 'ArrowRight':
                            this.nextSlide();
                            break;
                        case 'ArrowUp':
                            // Increase speed
                            if (this.slideshowSettings.duration < 10) {
                                this.slideshowSettings.duration = Math.min(10, this.slideshowSettings.duration + 1);
                                this.restartSlideshowIfPlaying();
                            }
                            break;
                        case 'ArrowDown':
                            // Decrease speed
                            if (this.slideshowSettings.duration > 2) {
                                this.slideshowSettings.duration = Math.max(2, this.slideshowSettings.duration - 1);
                                this.restartSlideshowIfPlaying();
                            }
                            break;
                        case 'l':
                        case 'L':
                            // Toggle loop
                            this.slideshowSettings.loop = !this.slideshowSettings.loop;
                            break;
                        case 'f':
                        case 'F':
                            // Toggle fullscreen
                            e.preventDefault();
                            this.toggleFullscreen();
                            break;
                    }
                }
            },
            
            async mounted() {
                await Promise.all([
                    this.loadPhotos(),
                    this.loadStats(),
                    this.loadKeywords(),
                    this.loadWorkspaces(),
                    this.loadProjects(),
                    this.loadBlurScores()
                ]);
                
                // Preload bursts in background
                setTimeout(() => this.loadBursts(), 1000);
            }
        }).mount('#app');
    </script>
</body>
</html>
